{% extends 'base.html' %}
{% load static %}

{% block title %}Ø¯ÙˆÙ‘Ø±Ù‡Ø§ | Ù…Ù†ØµØ© Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©{% endblock %}

{% block content %}
<!-- Header -->
<img src="{% static 'images/sadu-strip.jpeg' %}" alt="Ø³Ø¯Ùˆ Ø¹Ù„ÙˆÙŠ" class="sadu-img">

<header class="hero">
    <img src="{% static 'images/logodw.png' %}" alt="Ø´Ø¹Ø§Ø± Ø¯ÙˆÙ‘Ø±Ù‡Ø§" class="hero-logo fade-in">
    <h1 class="hero-title fade-in">ğŸ¡ Ø¯ÙˆÙ‘Ø±Ù‡Ø§ | Ù…Ù†ØµØªÙƒ Ù„Ø§Ø¨ØªÙƒØ§Ø± ØªØ¬Ø§Ø±Ø¨ ÙØ±ÙŠØ¯Ø©</h1>
    <p class="fade-in">Ø³Ø¬Ù‘Ù„ Ù…Ø¹Ù†Ø§ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø®Ø§ØµØ© Ù…Ø¹ Ø¹Ø¬Ù„Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆØ¬ÙˆØ§Ø¦Ø²Ùƒ Ø§Ù„Ø®Ø§ØµØ© âœ¨</p>
</header>

<!-- Tabs for switching between Company and Influencer forms -->
<div class="form-tabs fade-in" style="max-width: 800px; margin: 40px auto; display: flex; gap: 10px; justify-content: center; border-bottom: 2px solid #e9ecef;">
    <button class="tab-btn active" data-tab="company" style="flex: 1; padding: 15px; background: #6A3FA0; color: white; border: none; border-radius: 10px 10px 0 0; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s;">
        ğŸ¢ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª
    </button>
    <button class="tab-btn" data-tab="influencer" style="flex: 1; padding: 15px; background: #e9ecef; color: #6A3FA0; border: none; border-radius: 10px 10px 0 0; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s;">
        â­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø«Ø±ÙŠÙ†
    </button>
</div>

<!-- Company Registration Form -->
<section class="form-section fade-in" id="companyForm" style="display: block;">
    <h2>Ø³Ø¬Ù‘Ù„ Ø´Ø±ÙƒØªÙƒ</h2>
    <p class="form-note">â­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø´Ø±ÙƒØ§Øª ÙÙ‚Ø·</p>
    
    <form id="companyLeadForm" class="form">
        {% csrf_token %}
        <div class="grid">
            <label>
                Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©
                <div id="companyTypeContainer" style="width: 100%;">
                    <select name="type" id="companyTypeSelect" required style="width: 100%;">
                        <option value="restaurant">Ù…Ø·Ø¹Ù…</option>
                        <option value="resort">Ù…Ù†ØªØ¬Ø¹</option>
                        <option value="hotel">ÙÙ†Ø¯Ù‚</option>
                        <option value="coffee">ÙƒÙˆÙÙŠ</option>
                        <option value="cafe">Ù…Ù‚Ù‡Ù‰</option>
                        <option value="event">ÙØ¹Ø§Ù„ÙŠØ©</option>
                        <option value="other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
            </label>

            <label>
                Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©
                <input name="company" required>
            </label>

            <label>
                Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                <input type="email" name="email" required>
            </label>

            <label>
                Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„
                <input name="phone">
            </label>

            <label class="full">
                Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ÙˆØ§Ø­ØªÙ…Ø§Ù„Ø§Øª Ø§Ù„ÙÙˆØ² (Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©)
                <small style="display: block; color: #6c757d; margin-bottom: 10px; font-size: 13px;">
                    ğŸ’¡ ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯Øª Ø§Ù„Ù†Ø³Ø¨Ø© Ø²Ø§Ø¯ Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„ÙÙˆØ² Ø¨Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ù† 1% Ø¥Ù„Ù‰ 100%)
                </small>
                <div id="companyPrizesContainer" style="margin-top: 10px;">
                    <div class="prize-item" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center;">
                            <input type="text" class="prize-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ø«Ø§Ù„: Ø®ØµÙ… 10%)" required style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="number" class="prize-percentage" min="1" max="100" value="50" required style="width: 70px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-size: 14px;">
                                <span style="font-weight: bold; color: #6A3FA0;">%</span>
                            </div>
                            <button type="button" class="remove-prize-btn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Ø­Ø°Ù</button>
                        </div>
                    </div>
                </div>
                <button type="button" id="companyAddPrizeBtn" style="margin-top: 10px; padding: 8px 15px; background: #6A3FA0; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">+ Ø¥Ø¶Ø§ÙØ© Ø¬Ø§Ø¦Ø²Ø©</button>
                <div id="companyTotalPercentage" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-weight: bold; color: #1565c0; text-align: center;">
                    Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="companyTotalPercentValue">50</span>% (Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
                </div>
            </label>
        </div>

        <button type="submit" class="btn primary">Ø¥Ø±Ø³Ø§Ù„</button>
    </form>
</section>

<!-- Influencer Registration Form -->
<section class="form-section fade-in" id="influencerForm" style="display: none;">
    <h2>Ø³Ø¬Ù‘Ù„ Ø­Ø³Ø§Ø¨Ùƒ</h2>
    <p class="form-note">â­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø¤Ø«Ø±ÙŠÙ† ÙÙ‚Ø·</p>
    
    <form id="influencerLeadForm" class="form">
        {% csrf_token %}
        <div class="grid">
            <label>
                Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                <div id="influencerPlatformContainer" style="width: 100%;">
                    <select name="platform" id="influencerPlatformSelect" required style="width: 100%;">
                        <option value="instagram">Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</option>
                        <option value="tiktok">ØªÙŠÙƒ ØªÙˆÙƒ</option>
                        <option value="youtube">ÙŠÙˆØªÙŠÙˆØ¨</option>
                        <option value="snapchat">Ø³Ù†Ø§Ø¨ Ø´Ø§Øª</option>
                        <option value="twitter">ØªÙˆÙŠØªØ±</option>
                        <option value="other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
            </label>

            <label>
                Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø«Ø±
                <input name="name" required>
            </label>

            <label>
                Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø«Ø§Ù„: @username)
                <input name="username" placeholder="@username" required>
            </label>

            <label>
                Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                <input type="email" name="email" required>
            </label>

            <label>
                Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„
                <input name="phone">
            </label>

            <label>
                Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
                <input type="number" name="followers_count" min="0" placeholder="0">
            </label>

            <label class="full">
                Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²
                <small style="display: block; color: #6c757d; margin-bottom: 10px; font-size: 13px;">
                    ğŸ’¡ Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ù„ÙØ§Ø¦Ø² Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
                </small>
                <div id="influencerPrizesContainer" style="margin-top: 10px;">
                    <div class="prize-item" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                            <input type="text" class="prize-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ø«Ø§Ù„: Ø®ØµÙ… 10%)" required style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <button type="button" class="remove-prize-btn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Ø­Ø°Ù</button>
                        </div>
                    </div>
                </div>
                <button type="button" id="influencerAddPrizeBtn" style="margin-top: 10px; padding: 8px 15px; background: #6A3FA0; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">+ Ø¥Ø¶Ø§ÙØ© Ø¬Ø§Ø¦Ø²Ø©</button>
            </label>
        </div>

        <button type="submit" class="btn primary">Ø¥Ø±Ø³Ø§Ù„</button>
    </form>
</section>
{% endblock %}

{% block extra_js %}
<script>
/**
 * Tab switching functionality
 */
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const targetTab = this.dataset.tab;
        
        // Update button styles
        document.querySelectorAll('.tab-btn').forEach(b => {
            if (b.dataset.tab === targetTab) {
                b.style.background = '#6A3FA0';
                b.style.color = 'white';
                b.classList.add('active');
            } else {
                b.style.background = '#e9ecef';
                b.style.color = '#6A3FA0';
                b.classList.remove('active');
            }
        });
        
        // Show/hide forms
        if (targetTab === 'company') {
            document.getElementById('companyForm').style.display = 'block';
            document.getElementById('influencerForm').style.display = 'none';
        } else {
            document.getElementById('companyForm').style.display = 'none';
            document.getElementById('influencerForm').style.display = 'block';
        }
    });
});

/**
 * Show notification message
 */
function showNotification(message, type = "info") {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#3498db'};
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        ">
            ${message}
        </div>
    `;

    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification) {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

// ============= COMPANY FORM JAVASCRIPT =============

/**
 * Handle company type selection change
 */
const companyTypeSelect = document.getElementById("companyTypeSelect");
const companyTypeContainer = document.getElementById("companyTypeContainer");

if (companyTypeSelect) {
    companyTypeSelect.addEventListener("change", (e) => {
        if (e.target.value === "other") {
            const selectElement = e.target;
            const inputElement = document.createElement("input");
            inputElement.type = "text";
            inputElement.name = "customType";
            inputElement.id = "companyCustomTypeInput";
            inputElement.required = true;
            inputElement.placeholder = "Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø© (Ù…Ø«Ø§Ù„: ØµØ§Ù„ÙˆÙ†ØŒ Ø¹ÙŠØ§Ø¯Ø©ØŒ Ù…ØªØ¬Ø±...)";
            inputElement.style.width = '100%';
            inputElement.style.height = selectElement.offsetHeight + 'px';
            inputElement.style.padding = window.getComputedStyle(selectElement).padding;
            inputElement.style.border = window.getComputedStyle(selectElement).border;
            inputElement.style.borderRadius = window.getComputedStyle(selectElement).borderRadius;
            inputElement.style.fontSize = window.getComputedStyle(selectElement).fontSize;
            inputElement.style.fontFamily = window.getComputedStyle(selectElement).fontFamily;
            inputElement.style.boxSizing = 'border-box';
            inputElement.style.display = 'block';
            
            companyTypeContainer.innerHTML = '';
            companyTypeContainer.appendChild(inputElement);
            
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "type";
            hiddenInput.value = "other";
            companyTypeContainer.appendChild(hiddenInput);
            
            inputElement.focus();
        }
    });
}

/**
 * Company prize management
 */
const companyPrizesContainer = document.getElementById('companyPrizesContainer');
const companyAddPrizeBtn = document.getElementById('companyAddPrizeBtn');
const companyTotalPercentValue = document.getElementById('companyTotalPercentValue');

function updateCompanyTotalPercentage() {
    const percentages = Array.from(companyPrizesContainer.querySelectorAll('.prize-percentage'))
        .map(input => parseInt(input.value) || 0);
    const total = percentages.reduce((sum, val) => sum + val, 0);
    companyTotalPercentValue.textContent = total;
    
    const totalDiv = document.getElementById('companyTotalPercentage');
    if (total > 0) {
        totalDiv.style.background = '#e3f2fd';
        totalDiv.style.color = '#1565c0';
        totalDiv.innerHTML = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="companyTotalPercentValue">${total}</span>% (Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)`;
    } else {
        totalDiv.style.background = '#fff3cd';
        totalDiv.style.color = '#856404';
        totalDiv.innerHTML = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="companyTotalPercentValue">0</span>% (ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø¨ Ù…Ø¦ÙˆÙŠØ©)`;
    }
}

function addCompanyPrizeItem() {
    const prizeItem = document.createElement('div');
    prizeItem.className = 'prize-item';
    prizeItem.style.cssText = 'margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; position: relative;';
    
    prizeItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center;">
            <input type="text" class="prize-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ø«Ø§Ù„: Ø®ØµÙ… 10%)" required style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="number" class="prize-percentage" min="1" max="100" value="50" required style="width: 70px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-size: 14px;">
                <span style="font-weight: bold; color: #6A3FA0;">%</span>
            </div>
            <button type="button" class="remove-prize-btn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Ø­Ø°Ù</button>
        </div>
    `;
    
    companyPrizesContainer.appendChild(prizeItem);
    
    prizeItem.querySelector('.prize-percentage').addEventListener('input', updateCompanyTotalPercentage);
    prizeItem.querySelector('.remove-prize-btn').addEventListener('click', () => {
        if (companyPrizesContainer.querySelectorAll('.prize-item').length > 1) {
            prizeItem.remove();
            updateCompanyTotalPercentage();
        } else {
            showNotification('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        }
    });
    
    updateCompanyTotalPercentage();
}

if (companyAddPrizeBtn) {
    companyAddPrizeBtn.addEventListener('click', addCompanyPrizeItem);
}

// Add event listeners to existing company prize items
if (companyPrizesContainer) {
    companyPrizesContainer.querySelectorAll('.prize-percentage').forEach(input => {
        input.addEventListener('input', updateCompanyTotalPercentage);
    });
    
    companyPrizesContainer.querySelectorAll('.remove-prize-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const prizeItem = this.closest('.prize-item');
            if (companyPrizesContainer.querySelectorAll('.prize-item').length > 1) {
            prizeItem.remove();
                updateCompanyTotalPercentage();
        } else {
            showNotification('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        }
    });
});

    updateCompanyTotalPercentage();
}

/**
 * Company form submission
 */
const companyForm = document.getElementById("companyLeadForm");
if (companyForm) {
    companyForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const prizes = [];
    const percentages = [];
        companyPrizesContainer.querySelectorAll('.prize-item').forEach(item => {
        const name = item.querySelector('.prize-name').value.trim();
        const percentage = parseInt(item.querySelector('.prize-percentage').value);
        if (name && percentage) {
            prizes.push(name);
            percentages.push(percentage);
        }
    });
    
    if (prizes.length === 0) {
        showNotification('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', "error");
        return;
    }
    
        const submitBtn = companyForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

    try {
            const formData = new FormData(companyForm);
            const typeValue = formData.get('type') || document.querySelector('#companyTypeContainer [name="type"]')?.value || 'other';
        const customTypeValue = formData.get('customType') || '';
        
        const data = {
            company: formData.get('company'),
            type: typeValue,
            customType: typeValue === 'other' ? customTypeValue : '',
            email: formData.get('email'),
            phone: formData.get('phone'),
            prizes: prizes,
            prize_percentages: percentages
        };

            const csrfToken = companyForm.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        const response = await fetch('{% url "companies:register" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errorText = await response.text();
            try {
                const errorData = JSON.parse(errorText);
                showNotification(errorData.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…', "error");
            } catch (e) {
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (${response.status})`, "error");
            }
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        const result = await response.json();

        if (result.success) {
            showNotification(result.message, "success");
            setTimeout(() => {
                window.location.href = result.redirect_url;
            }, 2000);
        } else {
            showNotification(result.message, "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }

    } catch (error) {
        console.error('Error submitting form:', error);
        showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message || 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'}`, "error");
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});
}

// ============= INFLUENCER FORM JAVASCRIPT =============

/**
 * Handle influencer platform selection change
 */
const influencerPlatformSelect = document.getElementById("influencerPlatformSelect");
const influencerPlatformContainer = document.getElementById("influencerPlatformContainer");

if (influencerPlatformSelect) {
    influencerPlatformSelect.addEventListener("change", (e) => {
        if (e.target.value === "other") {
            const selectElement = e.target;
            const inputElement = document.createElement("input");
            inputElement.type = "text";
            inputElement.name = "customPlatform";
            inputElement.id = "influencerCustomPlatformInput";
            inputElement.required = true;
            inputElement.placeholder = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ© (Ù…Ø«Ø§Ù„: Ù„ÙŠÙ†ÙƒØ¯ Ø¥Ù†ØŒ Ø¨ÙŠÙ†ØªØ±ÙŠØ³Øª...)";
            inputElement.style.width = '100%';
            inputElement.style.height = selectElement.offsetHeight + 'px';
            inputElement.style.padding = window.getComputedStyle(selectElement).padding;
            inputElement.style.border = window.getComputedStyle(selectElement).border;
            inputElement.style.borderRadius = window.getComputedStyle(selectElement).borderRadius;
            inputElement.style.fontSize = window.getComputedStyle(selectElement).fontSize;
            inputElement.style.fontFamily = window.getComputedStyle(selectElement).fontFamily;
            inputElement.style.boxSizing = 'border-box';
            inputElement.style.display = 'block';
            
            influencerPlatformContainer.innerHTML = '';
            influencerPlatformContainer.appendChild(inputElement);
            
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "platform";
            hiddenInput.value = "other";
            influencerPlatformContainer.appendChild(hiddenInput);
            
            inputElement.focus();
        }
    });
}

/**
 * Influencer prize management (without percentages)
 */
const influencerPrizesContainer = document.getElementById('influencerPrizesContainer');
const influencerAddPrizeBtn = document.getElementById('influencerAddPrizeBtn');

function addInfluencerPrizeItem() {
    const prizeItem = document.createElement('div');
    prizeItem.className = 'prize-item';
    prizeItem.style.cssText = 'margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; position: relative;';
    
    prizeItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
            <input type="text" class="prize-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ø«Ø§Ù„: Ø®ØµÙ… 10%)" required style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <button type="button" class="remove-prize-btn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Ø­Ø°Ù</button>
        </div>
    `;
    
    influencerPrizesContainer.appendChild(prizeItem);
    
    prizeItem.querySelector('.remove-prize-btn').addEventListener('click', () => {
        if (influencerPrizesContainer.querySelectorAll('.prize-item').length > 1) {
            prizeItem.remove();
        } else {
            showNotification('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        }
    });
}

if (influencerAddPrizeBtn) {
    influencerAddPrizeBtn.addEventListener('click', addInfluencerPrizeItem);
}

// Add event listeners to existing influencer prize items
if (influencerPrizesContainer) {
    influencerPrizesContainer.querySelectorAll('.remove-prize-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const prizeItem = this.closest('.prize-item');
            if (influencerPrizesContainer.querySelectorAll('.prize-item').length > 1) {
                prizeItem.remove();
            } else {
                showNotification('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
            }
        });
    });
}

/**
 * Influencer form submission
 */
const influencerForm = document.getElementById("influencerLeadForm");
if (influencerForm) {
    influencerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const prizes = [];
        influencerPrizesContainer.querySelectorAll('.prize-item').forEach(item => {
            const name = item.querySelector('.prize-name').value.trim();
            if (name) {
                prizes.push(name);
            }
        });
        
        if (prizes.length === 0) {
            showNotification('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', "error");
            return;
        }
        
        const submitBtn = influencerForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

        try {
            const formData = new FormData(influencerForm);
            const platformValue = formData.get('platform') || document.querySelector('#influencerPlatformContainer [name="platform"]')?.value || 'other';
            const customPlatformValue = formData.get('customPlatform') || '';
            
            const data = {
                name: formData.get('name'),
                platform: platformValue,
                customPlatform: platformValue === 'other' ? customPlatformValue : '',
                username: formData.get('username'),
                followers_count: formData.get('followers_count') || 0,
                email: formData.get('email'),
                phone: formData.get('phone'),
                prizes: prizes
            };

            const csrfToken = influencerForm.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (!csrfToken) {
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', "error");
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }

            const response = await fetch('{% url "influencers:register" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    showNotification(errorData.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…', "error");
                } catch (e) {
                    showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (${response.status})`, "error");
                }
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }

            const result = await response.json();

            if (result.success) {
                showNotification(result.message || 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­', "success");
                setTimeout(() => {
                    if (result.redirect_url) {
                        window.location.href = result.redirect_url;
                    } else if (result.influencer_id) {
                        window.location.href = `/influencers/thanks/${result.influencer_id}/`;
                    }
                }, 2000);
            } else {
                showNotification(result.message, "error");
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }

        } catch (error) {
            console.error('Error submitting form:', error);
            showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message || 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'}`, "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
}
</script>
{% endblock %}
