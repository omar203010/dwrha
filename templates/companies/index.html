{% extends 'base.html' %}
{% load static %}

{% block title %}Ø¯ÙˆÙ‘Ø±Ù‡Ø§ | Ù…Ù†ØµØ© Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©{% endblock %}

{% block content %}
<!-- Header -->
<img src="{% static 'images/sadu-strip.jpeg' %}" alt="Ø³Ø¯Ùˆ Ø¹Ù„ÙˆÙŠ" class="sadu-img">

<header class="hero">
    <img src="{% static 'images/logodw.png' %}" alt="Ø´Ø¹Ø§Ø± Ø¯ÙˆÙ‘Ø±Ù‡Ø§" class="hero-logo fade-in">
    <h1 class="hero-title fade-in">ğŸ¡ Ø¯ÙˆÙ‘Ø±Ù‡Ø§ | Ù…Ù†ØµØªÙƒ Ù„Ø§Ø¨ØªÙƒØ§Ø± ØªØ¬Ø§Ø±Ø¨ ÙØ±ÙŠØ¯Ø© Ù…Ø¹ Ø¹Ù…Ù„Ø§Ø¡Ùƒ</h1>
    <p class="fade-in">Ø³Ø¬Ù‘Ù„ Ø´Ø±ÙƒØªÙƒ Ù…Ø¹Ù†Ø§ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø®Ø§ØµØ© Ù…Ø¹ Ø¹Ø¬Ù„Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆØ¬ÙˆØ§Ø¦Ø²Ùƒ Ø§Ù„Ø®Ø§ØµØ© âœ¨</p>
</header>

<!-- Registration Form -->
<section class="form-section fade-in" id="form">
    <h2>Ø³Ø¬Ù‘Ù„ Ø§Ù‡ØªÙ…Ø§Ù…Ùƒ</h2>
    <p class="form-note">â­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø´Ø±ÙƒØ§Øª ÙÙ‚Ø·</p>
    
    <form id="leadForm" class="form">
        {% csrf_token %}
        <div class="grid">
            <label>
                Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©
                <div id="typeContainer" style="width: 100%;">
                    <select name="type" id="typeSelect" required style="width: 100%;">
                        <option value="restaurant">Ù…Ø·Ø¹Ù…</option>
                        <option value="resort">Ù…Ù†ØªØ¬Ø¹</option>
                        <option value="hotel">ÙÙ†Ø¯Ù‚</option>
                        <option value="coffee">ÙƒÙˆÙÙŠ</option>
                        <option value="cafe">Ù…Ù‚Ù‡Ù‰</option>
                        <option value="event">ÙØ¹Ø§Ù„ÙŠØ©</option>
                        <option value="other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
            </label>

            <label>
                Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©
                <input name="company" required>
            </label>

            <label>
                Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                <input type="email" name="email" required>
            </label>

            <label>
                Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„
                <input name="phone">
            </label>

            <label class="full">
                Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ÙˆØ§Ø­ØªÙ…Ø§Ù„Ø§Øª Ø§Ù„ÙÙˆØ² (Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©)
                <small style="display: block; color: #6c757d; margin-bottom: 10px; font-size: 13px;">
                    ğŸ’¡ ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯Øª Ø§Ù„Ù†Ø³Ø¨Ø© Ø²Ø§Ø¯ Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„ÙÙˆØ² Ø¨Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ù† 1% Ø¥Ù„Ù‰ 100%)
                </small>
                <div id="prizesContainer" style="margin-top: 10px;">
                    <div class="prize-item" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center;">
                            <input type="text" class="prize-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ø«Ø§Ù„: Ø®ØµÙ… 10%)" required style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="number" class="prize-percentage" min="1" max="100" value="50" required style="width: 70px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-size: 14px;">
                                <span style="font-weight: bold; color: #6A3FA0;">%</span>
                            </div>
                            <button type="button" class="remove-prize-btn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Ø­Ø°Ù</button>
                        </div>
                    </div>
                </div>
                <button type="button" id="addPrizeBtn" style="margin-top: 10px; padding: 8px 15px; background: #6A3FA0; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">+ Ø¥Ø¶Ø§ÙØ© Ø¬Ø§Ø¦Ø²Ø©</button>
                <div id="totalPercentage" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-weight: bold; color: #1565c0; text-align: center;">
                    Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="totalPercentValue">50</span>% (Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
                </div>
            </label>
        </div>

        <button type="submit" class="btn primary">Ø¥Ø±Ø³Ø§Ù„</button>
    </form>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Elements
const form = document.getElementById("leadForm");
const typeSelect = document.getElementById("typeSelect");
const typeContainer = document.getElementById("typeContainer");

/**
 * Handle type selection change - convert select to input when "other" is selected
 */
typeSelect.addEventListener("change", (e) => {
    if (e.target.value === "other") {
        // Store the select element
        const selectElement = e.target;
        const selectValue = selectElement.value;
        
        // Create input element
        const inputElement = document.createElement("input");
        inputElement.type = "text";
        inputElement.name = "customType";
        inputElement.id = "customTypeInput";
        inputElement.required = true;
        inputElement.placeholder = "Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø© (Ù…Ø«Ø§Ù„: ØµØ§Ù„ÙˆÙ†ØŒ Ø¹ÙŠØ§Ø¯Ø©ØŒ Ù…ØªØ¬Ø±...)";
        
        // Copy styling from select and match company name field exactly
        const computedStyle = window.getComputedStyle(selectElement);
        const companyInput = document.querySelector('input[name="company"]');
        
        // Set width to 100% to match grid layout
        inputElement.style.width = '100%';
        inputElement.style.height = computedStyle.height;
        inputElement.style.padding = computedStyle.padding;
        inputElement.style.border = computedStyle.border;
        inputElement.style.borderRadius = computedStyle.borderRadius;
        inputElement.style.fontSize = computedStyle.fontSize;
        inputElement.style.fontFamily = computedStyle.fontFamily;
        inputElement.style.boxSizing = 'border-box';
        inputElement.style.display = 'block';
        inputElement.className = selectElement.className;
        
        // Match company input styling exactly if available
        if (companyInput) {
            const companyStyle = window.getComputedStyle(companyInput);
            inputElement.style.height = companyStyle.height;
            inputElement.style.padding = companyStyle.padding;
            inputElement.style.border = companyStyle.border;
            inputElement.style.borderRadius = companyStyle.borderRadius;
            inputElement.style.fontSize = companyStyle.fontSize;
        }
        
        // Replace select with input
        typeContainer.innerHTML = '';
        typeContainer.appendChild(inputElement);
        
        // Focus on input
        inputElement.focus();
        
        // Add hidden input to store type="other"
        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = "type";
        hiddenInput.value = "other";
        typeContainer.appendChild(hiddenInput);
        
        // Add back button or change listener to restore select
        inputElement.addEventListener("blur", function() {
            // Optionally restore select if input is empty
            if (!this.value.trim()) {
                restoreSelect();
            }
        });
        
        // Add escape key to restore select
        inputElement.addEventListener("keydown", function(e) {
            if (e.key === "Escape") {
                restoreSelect();
            }
        });
    }
});

/**
 * Restore select element
 */
function restoreSelect() {
    typeContainer.innerHTML = `
        <select name="type" id="typeSelect" required style="width: 100%;">
            <option value="restaurant">Ù…Ø·Ø¹Ù…</option>
            <option value="resort">Ù…Ù†ØªØ¬Ø¹</option>
            <option value="hotel">ÙÙ†Ø¯Ù‚</option>
            <option value="coffee">ÙƒÙˆÙÙŠ</option>
            <option value="cafe">Ù…Ù‚Ù‡Ù‰</option>
            <option value="event">ÙØ¹Ø§Ù„ÙŠØ©</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
        </select>
    `;
    
    // Re-attach event listener
    const newSelect = document.getElementById("typeSelect");
    newSelect.addEventListener("change", function(e) {
        if (e.target.value === "other") {
            const selectElement = e.target;
            const inputElement = document.createElement("input");
            inputElement.type = "text";
            inputElement.name = "customType";
            inputElement.id = "customTypeInput";
            inputElement.required = true;
            inputElement.placeholder = "Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø© (Ù…Ø«Ø§Ù„: ØµØ§Ù„ÙˆÙ†ØŒ Ø¹ÙŠØ§Ø¯Ø©ØŒ Ù…ØªØ¬Ø±...)";
            
            // Copy styling from select and match company name field exactly
            const computedStyle = window.getComputedStyle(selectElement);
            const companyInput = document.querySelector('input[name="company"]');
            
            // Set width to 100% to match grid layout
            inputElement.style.width = '100%';
            inputElement.style.height = computedStyle.height;
            inputElement.style.padding = computedStyle.padding;
            inputElement.style.border = computedStyle.border;
            inputElement.style.borderRadius = computedStyle.borderRadius;
            inputElement.style.fontSize = computedStyle.fontSize;
            inputElement.style.fontFamily = computedStyle.fontFamily;
            inputElement.style.boxSizing = 'border-box';
            inputElement.style.display = 'block';
            inputElement.className = selectElement.className;
            
            // Match company input styling exactly if available
            if (companyInput) {
                const companyStyle = window.getComputedStyle(companyInput);
                inputElement.style.height = companyStyle.height;
                inputElement.style.padding = companyStyle.padding;
                inputElement.style.border = companyStyle.border;
                inputElement.style.borderRadius = companyStyle.borderRadius;
                inputElement.style.fontSize = companyStyle.fontSize;
            }
            
            typeContainer.innerHTML = '';
            typeContainer.appendChild(inputElement);
            
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "type";
            hiddenInput.value = "other";
            typeContainer.appendChild(hiddenInput);
            
            inputElement.focus();
            
            inputElement.addEventListener("blur", function() {
                if (!this.value.trim()) {
                    restoreSelect();
                }
            });
            
            inputElement.addEventListener("keydown", function(e) {
                if (e.key === "Escape") {
                    restoreSelect();
                }
            });
        }
    });
}

/**
 * Show notification message
 */
function showNotification(message, type = "info") {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#3498db'};
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        ">
            ${message}
        </div>
    `;

    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification) {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

/**
 * Handle prize management
 */
const prizesContainer = document.getElementById('prizesContainer');
const addPrizeBtn = document.getElementById('addPrizeBtn');
const totalPercentValue = document.getElementById('totalPercentValue');

function updateTotalPercentage() {
    const percentages = Array.from(document.querySelectorAll('.prize-percentage'))
        .map(input => parseInt(input.value) || 0);
    const total = percentages.reduce((sum, val) => sum + val, 0);
    totalPercentValue.textContent = total;
    
    // Show info message - percentages will be normalized automatically
    const totalDiv = document.getElementById('totalPercentage');
    if (total > 0) {
        totalDiv.style.background = '#e3f2fd';
        totalDiv.style.color = '#1565c0';
        totalDiv.innerHTML = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="totalPercentValue">${total}</span>% (Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)`;
    } else {
        totalDiv.style.background = '#fff3cd';
        totalDiv.style.color = '#856404';
        totalDiv.innerHTML = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="totalPercentValue">0</span>% (ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø¨ Ù…Ø¦ÙˆÙŠØ©)`;
    }
}

function addPrizeItem() {
    const prizeItem = document.createElement('div');
    prizeItem.className = 'prize-item';
    prizeItem.style.cssText = 'margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; position: relative;';
    
    prizeItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center;">
            <input type="text" class="prize-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ù…Ø«Ø§Ù„: Ø®ØµÙ… 10%)" required style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="number" class="prize-percentage" min="1" max="100" value="50" required style="width: 70px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-size: 14px;">
                <span style="font-weight: bold; color: #6A3FA0;">%</span>
            </div>
            <button type="button" class="remove-prize-btn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Ø­Ø°Ù</button>
        </div>
    `;
    
    prizesContainer.appendChild(prizeItem);
    
    // Add event listeners
    prizeItem.querySelector('.prize-percentage').addEventListener('input', updateTotalPercentage);
    prizeItem.querySelector('.remove-prize-btn').addEventListener('click', () => {
        if (document.querySelectorAll('.prize-item').length > 1) {
            prizeItem.remove();
            updateTotalPercentage();
        } else {
            showNotification('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        }
    });
    
    updateTotalPercentage();
}

addPrizeBtn.addEventListener('click', addPrizeItem);

// Add event listeners to existing prize items
document.querySelectorAll('.prize-percentage').forEach(input => {
    input.addEventListener('input', updateTotalPercentage);
});

// Add event listeners to existing remove buttons
document.querySelectorAll('.remove-prize-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const prizeItem = this.closest('.prize-item');
        if (document.querySelectorAll('.prize-item').length > 1) {
            prizeItem.remove();
            updateTotalPercentage();
        } else {
            showNotification('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        }
    });
});

// Initial update
updateTotalPercentage();

/**
 * Handle form submission
 */
form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    // Collect prizes with percentages
    const prizes = [];
    const percentages = [];
    document.querySelectorAll('.prize-item').forEach(item => {
        const name = item.querySelector('.prize-name').value.trim();
        const percentage = parseInt(item.querySelector('.prize-percentage').value);
        if (name && percentage) {
            prizes.push(name);
            percentages.push(percentage);
        }
    });
    
    if (prizes.length === 0) {
        showNotification('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', "error");
        return;
    }
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

    try {
        const formData = new FormData(form);
        // Get type and customType
        const typeValue = formData.get('type') || document.querySelector('[name="type"]')?.value || 'other';
        const customTypeValue = formData.get('customType') || '';
        
        const data = {
            company: formData.get('company'),
            type: typeValue,
            customType: typeValue === 'other' ? customTypeValue : '',
            email: formData.get('email'),
            phone: formData.get('phone'),
            prizes: prizes,
            prize_percentages: percentages
        };

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        const response = await fetch('{% url "companies:register" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });

        // Check if response is ok
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error:', response.status, errorText);
            try {
                const errorData = JSON.parse(errorText);
                showNotification(errorData.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…', "error");
            } catch (e) {
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (${response.status})`, "error");
            }
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        const result = await response.json();

        if (result.success) {
            showNotification(result.message, "success");
            setTimeout(() => {
                window.location.href = result.redirect_url;
            }, 2000);
        } else {
            showNotification(result.message, "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }

    } catch (error) {
        console.error('Error submitting form:', error);
        showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message || 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'}`, "error");
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});
</script>
{% endblock %}
