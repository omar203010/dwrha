{% extends 'base.html' %}
{% load static %}

{% block title %}Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - {{ influencer.name }} | Ø¯ÙˆÙ‘Ø±Ù‡Ø§{% endblock %}

{% block content %}
<!-- Header -->
<img src="{% static 'images/sadu-strip.jpeg' %}" alt="Ø³Ø¯Ùˆ Ø¹Ù„ÙˆÙŠ" class="sadu-img">

<header class="hero">
    <img src="{% static 'images/logodw.png' %}" alt="Ø´Ø¹Ø§Ø± Ø¯ÙˆÙ‘Ø±Ù‡Ø§" class="hero-logo fade-in">
    <h1 class="hero-title fade-in">ğŸ‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ø­Ø¨</h1>
    <p class="fade-in">Ø³Ø¬Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ±Ø¨Ø­ Ø¬ÙˆØ§Ø¦Ø² Ø±Ø§Ø¦Ø¹Ø© Ù…Ù† {{ influencer.name }} âœ¨</p>
</header>

<!-- Registration Form -->
<section class="form-section fade-in" id="form">
    <h2>Ø³Ø¬Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h2>
    
    <form id="participantForm" class="form">
        {% csrf_token %}
        <div class="grid">
            <label>
                Ø§Ù„Ø§Ø³Ù…
                <input name="name" required placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
            </label>

            <label>
                Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
                <input name="phone" required placeholder="05XXXXXXXX" pattern="05[0-9]{8}">
                <small style="color: #6c757d; font-size: 12px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 10 Ø£Ø±Ù‚Ø§Ù…</small>
            </label>

            <label>
                Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ
                <input name="social_media_account" required placeholder="@username">
                <small style="color: #6c757d; font-size: 12px;">Ù…Ø«Ø§Ù„: @username</small>
            </label>

            <label>
                Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                <input name="city" required placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
            </label>
        </div>

        <button type="submit" class="btn primary">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù† ğŸ</button>
    </form>
</section>
{% endblock %}

{% block extra_js %}
<script>
function showNotification(message, type = "info") {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#3498db'};
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        ">
            ${message}
        </div>
    `;

    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification) {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

const form = document.getElementById("participantForm");
form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

    try {
        const formData = new FormData(form);
        
        const data = {
            name: formData.get('name'),
            phone: formData.get('phone'),
            social_media_account: formData.get('social_media_account'),
            city: formData.get('city')
        };

        // Validate phone format
        const phonePattern = /^05[0-9]{8}$/;
        if (!phonePattern.test(data.phone)) {
            showNotification('Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 10 Ø£Ø±Ù‚Ø§Ù…', "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        const response = await fetch('{% url "influencers:register_participant_submit" slug=influencer.slug %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errorText = await response.text();
            try {
                const errorData = JSON.parse(errorText);
                showNotification(errorData.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…', "error");
            } catch (e) {
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (${response.status})`, "error");
            }
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        const result = await response.json();

        if (result.success) {
            showNotification(result.message || 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰', "success");
            setTimeout(() => {
                form.reset();
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }, 2000);
        } else {
            showNotification(result.message, "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }

    } catch (error) {
        console.error('Error submitting form:', error);
        showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message || 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'}`, "error");
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});
</script>
{% endblock %}

