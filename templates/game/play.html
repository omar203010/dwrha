{% extends 'base.html' %}
{% load static %}

{% block title %}{{ company.name }} | Ø¯ÙˆÙ‘Ø±Ù‡Ø§{% endblock %}

{% block content %}
<!-- Header -->
<img src="{% static 'images/sadu-strip.jpeg' %}" alt="Ø³Ø¯Ùˆ Ø¹Ù„ÙˆÙŠ" class="sadu-img">

<header class="hero">
    <img src="{% static 'images/logodw.png' %}" alt="Ø´Ø¹Ø§Ø± Ø¯ÙˆÙ‘Ø±Ù‡Ø§" class="hero-logo">
</header>

<!-- Main Content -->
<main class="stage">
    {% if status == 'rejected' %}
    <!-- Status Message -->
    <section class="status-message-card fade-in">
        <div class="status-icon">âŒ</div>
        <h2>Ù†Ø¹ØªØ°Ø±ØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ</h2>
        <p>Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ù… ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.</p>
        
        <div class="company-info-box">
            <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø·Ù„Ø¨Ùƒ:</h3>
            <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©:</strong> {{ company.name }}</p>
            <p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©:</strong> {{ company.final_type }}</p>
            <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> {{ company.email }}</p>
            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> 
                <span class="status-badge status-{{ status }}">âŒ Ù…Ø±ÙÙˆØ¶</span>
            </p>
        </div>
    </section>
    {% elif not is_active %}
    <!-- Inactive Status Message -->
    <section class="status-message-card fade-in">
        <div class="status-icon">â¸ï¸</div>
        <h2>Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„</h2>
        <p>Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø¯ÙˆÙ‘Ø±Ù‡Ø§ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨.</p>
        
        <div class="company-info-box">
            <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø·Ù„Ø¨Ùƒ:</h3>
            <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©:</strong> {{ company.name }}</p>
            <p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©:</strong> {{ company.final_type }}</p>
            <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> {{ company.email }}</p>
            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> 
                <span class="status-badge status-{{ company.dynamic_status }}">
                    {% if company.dynamic_status == 'active' %}ğŸŸ¢ Ù†Ø´Ø· Ø§Ù„Ø¢Ù†
                    {% elif company.dynamic_status == 'scheduled' %}ğŸ“… Ù…Ø¬Ø¯ÙˆÙ„
                    {% elif company.dynamic_status == 'inactive' %}ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·
                    {% elif company.dynamic_status == 'pending' %}â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                    {% elif company.dynamic_status == 'approved' %}âœ… Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡
                    {% elif company.dynamic_status == 'rejected' %}âŒ Ù…Ø±ÙÙˆØ¶
                    {% else %}â“ ØºÙŠØ± Ù…Ø­Ø¯Ø¯
                    {% endif %}
                </span>
            </p>
            {% if company.schedules.exists %}
                {% for schedule in company.schedules.all %}
                    {% if schedule.is_active %}
                        <p><strong>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</strong> 
                            {% if schedule.saturday %}Ø§Ù„Ø³Ø¨Øª{% endif %}
                            {% if schedule.sunday %}Ø§Ù„Ø£Ø­Ø¯{% endif %}
                            {% if schedule.monday %}Ø§Ù„Ø§Ø«Ù†ÙŠÙ†{% endif %}
                            {% if schedule.tuesday %}Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡{% endif %}
                            {% if schedule.wednesday %}Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡{% endif %}
                            {% if schedule.thursday %}Ø§Ù„Ø®Ù…ÙŠØ³{% endif %}
                            {% if schedule.friday %}Ø§Ù„Ø¬Ù…Ø¹Ø©{% endif %}
                            {{ schedule.get_time_display }}
                        </p>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
    </section>
    {% else %}
    <!-- Game Section - Show when approved and active -->
    <!-- Name and Phone Input Form -->
    <section id="nameSection" class="name-form-card fade-in">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹</h2>
        <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ Ù„ØªØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</p>
        
        <form id="nameForm" class="form">
            <label>
                Ø§Ù„Ø§Ø³Ù…
                <input id="visitorName" type="text" required placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" style="font-size:16px;">
            </label>
            <label>
                Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                <input id="visitorPhone" type="tel" placeholder="05xxxxxxxx" pattern="05[0-9]{8}" style="font-size:16px;">
                <small class="field-hint">Ù…Ø«Ø§Ù„: 0501234567 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</small>
            </label>
            <button type="submit" class="btn primary" style="width:100%;">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ ğŸ¡</button>
        </form>
    </section>

    <!-- Wheel Section -->
    <div id="wheelSection" class="wheel-wrap" style="display:none; margin-top:30px;">
        <div class="needle"></div>
        <canvas id="wheelCanvas" width="560" height="560"></canvas>
        <button id="spinBtn" class="btn primary">Ø¬Ø±Ù‘Ø¨ Ø­Ø¸Ùƒ âœ¨</button>
        <div id="resultText" class="result"></div>
    </div>
    {% endif %}
</main>
{% endblock %}

{% block extra_js %}
<style>
.status-message-card {
    background: #fff;
    padding: 50px 40px;
    border-radius: 20px;
    box-shadow: 0 12px 40px rgba(106, 63, 160, 0.15);
    max-width: 500px;
    margin: 50px auto;
    text-align: center;
    border: 2px solid rgba(106, 63, 160, 0.1);
}

.status-icon {
    font-size: 80px;
    margin-bottom: 20px;
}

.status-message-card h2 {
    color: var(--purple);
    margin-bottom: 20px;
    font-size: 28px;
    font-weight: 900;
}

.status-message-card p {
    font-size: 18px;
    line-height: 1.8;
    margin-bottom: 30px;
    color: #5A4B70;
    font-weight: 600;
}

.company-info-box {
    margin: 20px 0;
    padding: 20px;
    background: rgba(106, 63, 160, 0.1);
    border-radius: 12px;
    text-align: right;
}

.company-info-box h3 {
    color: var(--purple);
    margin: 0 0 15px;
    font-size: 20px;
}

.company-info-box p {
    margin: 8px 0;
    font-size: 16px;
    color: #333;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 700;
    margin-right: 8px;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.status-approved {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-rejected {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.status-active {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-scheduled {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.field-hint {
    display: block;
    color: #6c757d;
    font-size: 12px;
    margin-top: 4px;
    font-style: italic;
}
</style>
<script>
{% if is_active %}
// Game data
const companySlug = "{{ company.slug }}";
const prizes = {{ prizes|safe }};
const colors = {{ colors|safe }};
let currentVisitorName = "";
let currentVisitorPhone = "";

// DOM Elements
const nameSection = document.getElementById("nameSection");
const wheelSection = document.getElementById("wheelSection");
const nameForm = document.getElementById("nameForm");
const visitorNameInput = document.getElementById("visitorName");
const visitorPhoneInput = document.getElementById("visitorPhone");
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas?.getContext("2d");
const spinBtn = document.getElementById("spinBtn");
const resultText = document.getElementById("resultText");

let spinning = false;

/**
 * Handle Name Form Submission
 */
nameForm.addEventListener("submit", (e) => {
    e.preventDefault();
    currentVisitorName = visitorNameInput.value.trim();
    currentVisitorPhone = visitorPhoneInput.value.trim();
    
    // Validate phone number (optional)
    const phonePattern = /^05[0-9]{8}$/;
    if (currentVisitorPhone && !phonePattern.test(currentVisitorPhone)) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: 0501234567) Ø£Ùˆ ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹');
        visitorPhoneInput.focus();
        return;
    }
    
    if (currentVisitorName) {
        wheelSection.style.display = "flex";
        wheelSection.classList.add("fade-in");
        
        visitorNameInput.disabled = true;
        visitorPhoneInput.disabled = true;
        const submitBtn = nameForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
        submitBtn.style.background = "#2ecc71";
        
        if (prizes.length > 0) {
            drawWheel();
        }
        
        setTimeout(() => {
            wheelSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
});

/**
 * Draw Wheel
 */
function drawWheel() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const numSeg = prizes.length;
    const arc = (2 * Math.PI) / numSeg;
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = canvas.width / 2 - 8;

    for (let i = 0; i < numSeg; i++) {
        ctx.beginPath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, i * arc, (i + 1) * arc);
        ctx.lineTo(centerX, centerY);
        ctx.fill();
        
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 3;
        ctx.stroke();

        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(i * arc + arc / 2);
        ctx.fillStyle = "#fff";
        ctx.font = "bold 20px Cairo";
        ctx.textAlign = "right";
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 1;
        ctx.shadowOffsetY = 1;
        ctx.fillText(prizes[i], radius - 20, 10);
        ctx.restore();
    }
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, 30, 0, 2 * Math.PI);
    ctx.fillStyle = "#2F1D52";
    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 4;
    ctx.stroke();
}

/**
 * Spin Wheel
 */
async function spinWheel() {
    if (spinning) return;
    spinning = true;
    spinBtn.disabled = true;
    spinBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†... â³';

    try {
        // Get the prize from server FIRST
        const response = await fetch(`/game/spin/${companySlug}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                visitor_name: currentVisitorName,
                visitor_phone: currentVisitorPhone
            })
        });

        const result = await response.json();
        
        if (!result.success) {
            alert(result.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†');
            spinning = false;
            spinBtn.disabled = false;
            spinBtn.textContent = 'Ø¬Ø±Ù‘Ø¨ Ø­Ø¸Ùƒ âœ¨';
            return;
        }

        const wonPrize = (result.prize || '').trim();
        // Normalize prizes to avoid whitespace/diacritics mismatch
        const normalizedPrizes = prizes.map(p => (p || '').toString().trim());
        let prizeIndex = normalizedPrizes.indexOf(wonPrize);
        if (prizeIndex === -1) {
            // Fallback: try case-insensitive match
            prizeIndex = normalizedPrizes.findIndex(p => p.toLowerCase() === wonPrize.toLowerCase());
        }
        if (prizeIndex === -1) {
            // If still not found, default to first segment to avoid crash
            prizeIndex = 0;
        }
        
        // Calculate rotation to land on the correct prize
        const spins = Math.floor(Math.random() * 3) + 5; // 5-7 full spins
        const segmentAngle = (2 * Math.PI) / prizes.length;
        
        // Calculate the angle to center on the prize
        // Pointer is at the top (12 o'clock) which is -90deg (âˆ’Ï€/2) from the canvas +X axis
        const pointerAngle = -Math.PI / 2;
        const segmentMidAngle = prizeIndex * segmentAngle + (segmentAngle / 2);
        // Rotate the wheel so that segmentMidAngle aligns with pointerAngle
        const targetAngle = (pointerAngle - segmentMidAngle);
        const finalAngle = (2 * Math.PI * spins) + targetAngle;

        let start = null;
        const duration = 4000; // 4 seconds

        function animate(timestamp) {
            if (!start) start = timestamp;
            const progress = Math.min((timestamp - start) / duration, 1);
            const angle = easeOutCubic(progress) * finalAngle;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(angle);
            ctx.translate(-canvas.width / 2, -canvas.height / 2);
            drawWheel();
            ctx.restore();

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                spinning = false;
                spinBtn.disabled = false;
                spinBtn.textContent = 'Ø¬Ø±Ù‘Ø¨ Ø­Ø¸Ùƒ âœ¨';
                
                resultText.textContent = `ğŸ‰ Ø±Ø¨Ø­Øª: ${wonPrize}`;
                resultText.style.animation = "pulse 1s ease-in-out 3";
                
                canvas.style.transform = "scale(1.05)";
                setTimeout(() => {
                    canvas.style.transform = "scale(1)";
                }, 500);

                setTimeout(() => {
                    showPrizeModal(wonPrize);
                }, 1000);
            }
        }
        requestAnimationFrame(animate);

    } catch (err) {
        console.error("Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:", err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        spinning = false;
        spinBtn.disabled = false;
        spinBtn.textContent = 'Ø¬Ø±Ù‘Ø¨ Ø­Ø¸Ùƒ âœ¨';
    }
}

/**
 * Easing function
 */
function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
}

/**
 * Show Prize Modal
 */
function showPrizeModal(prize) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
    `;
    
    modal.innerHTML = `
        <div style="
            background: #fff;
            border-radius: 20px;
            padding: 40px 30px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            font-family: 'Cairo', sans-serif;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            animation: fadeIn 0.4s ease;
        ">
            <h2 style="color:#2ecc71;font-size:32px;margin:0 0 15px;">ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ ${currentVisitorName}!</h2>
            <p style="font-size:24px;margin:15px 0 30px;color:#333;font-weight:bold;">${prize}</p>
            <button id="continueBtn" style="
                background:#6A3FA0;
                color:white;
                border:none;
                padding:14px 30px;
                border-radius:12px;
                cursor:pointer;
                font-size:18px;
                font-weight:bold;
                box-shadow: 0 4px 12px rgba(106,63,160,0.4);
                transition: all 0.3s ease;
            ">ğŸ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Handle button click
    modal.querySelector('#continueBtn').addEventListener('click', () => {
        // Remove modal
        modal.remove();
        
        // Hide wheel section
        wheelSection.style.display = 'none';
        
        // Reset form
        nameForm.reset();
        visitorNameInput.disabled = false;
        visitorPhoneInput.disabled = false;
        const submitBtn = nameForm.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ ğŸ¡";
        submitBtn.style.background = "";
        
        // Clear result text
        resultText.textContent = '';
        
        // Show name section and scroll to it
        nameSection.style.display = 'block';
        setTimeout(() => {
            nameSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    });
}

// Event Listeners
spinBtn.addEventListener("click", spinWheel);
{% endif %}
</script>
{% endblock %}
