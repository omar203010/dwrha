<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم | دوّرها</title>
  
  <!-- 🔒 إخفاء الصفحة من محركات البحث -->
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  
  <!-- مكتبة Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- مكتبة Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  
  <!-- إعداد الاتصال -->
  <script defer src="supabase.js"></script>
  <script defer src="auth.js"></script>
  
  <style>
    :root {
      --admin-primary: #e74c3c;
      --admin-secondary: #3498db;
    }

    .admin-header {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(231,76,60,0.3);
    }

    .admin-header h1 {
      margin: 0;
      font-size: 32px;
    }

    .admin-header p {
      margin: 10px 0 0;
      opacity: 0.9;
    }

    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .mega-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .mega-card {
      background: linear-gradient(135deg, var(--purple) 0%, #8C59C4 100%);
      color: white;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(106,63,160,0.3);
      transition: transform 0.3s ease;
    }

    .mega-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(106,63,160,0.4);
    }

    .mega-card.red {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .mega-card.green {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }

    .mega-card.blue {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    .mega-card.orange {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .mega-card .icon {
      font-size: 50px;
      margin-bottom: 15px;
    }

    .mega-card .value {
      font-size: 48px;
      font-weight: 900;
      margin: 10px 0;
    }

    .mega-card .label {
      font-size: 16px;
      opacity: 0.9;
    }

    .companies-table {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin: 30px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow-x: auto;
    }

    .companies-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .companies-table th {
      background: var(--purple);
      color: white;
      padding: 15px;
      text-align: right;
      font-weight: 700;
    }

    .companies-table td {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .companies-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .badge.top {
      background: #2ecc71;
      color: white;
    }

    .badge.medium {
      background: #f39c12;
      color: white;
    }

    .badge.low {
      background: #95a5a6;
      color: white;
    }

    .chart-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .chart-container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .export-section {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin: 30px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
    }

    .export-btn {
      background: #2ecc71;
      color: white;
      padding: 12px 30px;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      margin: 0 10px;
      transition: all 0.3s ease;
    }

    .export-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .export-btn.excel {
      background: #27ae60;
    }

    .loading {
      text-align: center;
      padding: 60px;
      font-size: 20px;
      color: var(--purple);
    }
  </style>
</head>
<body>
  <!-- هيدر إداري -->
  <div class="admin-header">
    <h1>🔐 لوحة التحكم</h1>
    <p id="adminName">مرحباً بك في لوحة التحكم</p>
    <button onclick="window.authSystem.logout()" style="
      position:absolute;
      top:20px;
      left:20px;
      background:rgba(255,255,255,0.2);
      color:white;
      border:none;
      padding:8px 15px;
      border-radius:8px;
      cursor:pointer;
      font-family:'Cairo',sans-serif;
      font-weight:700;
    ">🚪 تسجيل الخروج</button>
  </div>

  <div class="dashboard">
    <div id="loadingAdmin" class="loading">⏳ جاري تحميل البيانات الإدارية...</div>

    <!-- الإحصائيات الضخمة -->
    <div class="mega-stats" id="megaStats" style="display:none;">
      <div class="mega-card">
        <div class="icon">🏢</div>
        <div class="value" id="totalCompanies">0</div>
        <div class="label">إجمالي الشركات</div>
      </div>

      <div class="mega-card red">
        <div class="icon">🎡</div>
        <div class="value" id="totalSpinsAll">0</div>
        <div class="label">إجمالي الدورات</div>
      </div>

      <div class="mega-card green">
        <div class="icon">👥</div>
        <div class="value" id="totalVisitors">0</div>
        <div class="label">إجمالي الزوار</div>
      </div>

      <div class="mega-card blue">
        <div class="icon">📅</div>
        <div class="value" id="spinsToday">0</div>
        <div class="label">دورات اليوم</div>
      </div>

      <div class="mega-card orange">
        <div class="icon">📊</div>
        <div class="value" id="spinsWeek">0</div>
        <div class="label">دورات الأسبوع</div>
      </div>
    </div>

    <!-- الرسوم البيانية -->
    <div class="chart-row" id="chartsRow" style="display:none;">
      <div class="chart-container">
        <h3>📈 نمو الدورات - آخر 30 يوم</h3>
        <canvas id="growthChart"></canvas>
      </div>

      <div class="chart-container">
        <h3>🏆 أفضل 5 شركات</h3>
        <canvas id="topCompaniesChart"></canvas>
      </div>
    </div>

    <!-- جدول الشركات -->
    <div class="companies-table" id="companiesTable" style="display:none;">
      <h3>📋 جميع الشركات وأدائها</h3>
      <table>
        <thead>
          <tr>
            <th>الشركة</th>
            <th>النوع</th>
            <th>الدورات</th>
            <th>الزوار</th>
            <th>آخر نشاط</th>
            <th>الأداء</th>
          </tr>
        </thead>
        <tbody id="companiesTableBody"></tbody>
      </table>
    </div>

    <!-- قسم التصدير -->
    <div class="export-section" id="exportSection" style="display:none;">
      <h3>📥 تصدير التقارير</h3>
      <p>قم بتصدير جميع البيانات لتحليل شامل</p>
      <button class="export-btn" onclick="exportAdminCSV()">📊 تصدير CSV</button>
      <button class="export-btn excel" onclick="exportDetailedReport()">📑 تقرير تفصيلي</button>
    </div>
  </div>

  <footer class="footer">© 2025 Dawerha – Admin Dashboard</footer>

  <script>
    let allCompaniesData = [];
    let allSpinsData = [];

    // 🔐 التحقق من تسجيل دخول الإدارة
    async function checkAdminAuth() {
      // 🔒 التحقق من أن الصفحة مفتوحة عبر /admin فقط
      if (!window.location.pathname.includes('/admin')) {
        // إخفاء المحتوى وإظهار رسالة خطأ
        document.body.innerHTML = `
          <div style="text-align:center; padding:100px; font-family:'Cairo',sans-serif;">
            <h1 style="color:#e74c3c;">🚫 غير مسموح</h1>
            <p>هذه الصفحة متاحة فقط عبر الرابط المخصص للإدارة</p>
            <a href="/" style="color:var(--purple);">العودة للصفحة الرئيسية</a>
          </div>
        `;
        return null;
      }

      const session = await window.authSystem.requireAuth('admin');
      
      if (!session) {
        return null; // سيتم إعادة التوجيه تلقائياً
      }

      // عرض اسم المسؤول
      document.getElementById('adminName').textContent = `مرحباً ${session.name} - ${session.role === 'super_admin' ? 'مدير عام' : 'مدير'}`;

      return session;
    }

    // 🔹 تحميل البيانات الإدارية
    async function loadAdminDashboard() {
      try {
        // جلب جميع الشركات
        const { data: companies, error: companiesError } = await supabaseClient
          .from("companies")
          .select("*")
          .eq("status", "approved");

        if (companiesError) throw companiesError;

        // جلب جميع الدورات
        const { data: spins, error: spinsError } = await supabaseClient
          .from("game_spins")
          .select("*")
          .order("created_at", { ascending: false });

        if (spinsError) throw spinsError;

        allCompaniesData = companies;
        allSpinsData = spins;

        // حساب الإحصائيات
        calculateAdminStats(companies, spins);
        
        // رسم الرسوم البيانية
        drawGrowthChart(spins);
        drawTopCompaniesChart(companies, spins);
        
        // عرض جدول الشركات
        renderCompaniesTable(companies, spins);

        // إخفاء التحميل وإظهار المحتوى
        document.getElementById('loadingAdmin').style.display = 'none';
        document.getElementById('megaStats').style.display = 'grid';
        document.getElementById('chartsRow').style.display = 'grid';
        document.getElementById('companiesTable').style.display = 'block';
        document.getElementById('exportSection').style.display = 'block';

      } catch (err) {
        console.error("خطأ:", err);
        document.getElementById('loadingAdmin').innerHTML = `
          <div style="color:#e74c3c;">❌ حدث خطأ في تحميل البيانات</div>
        `;
      }
    }

    // 🔹 حساب الإحصائيات الإدارية
    function calculateAdminStats(companies, spins) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

      const totalCompanies = companies.length;
      const totalSpinsAll = spins.length;
      const totalVisitors = new Set(spins.map(s => s.visitor_name)).size;
      const spinsToday = spins.filter(s => new Date(s.created_at) >= today).length;
      const spinsWeek = spins.filter(s => new Date(s.created_at) >= weekAgo).length;

      document.getElementById('totalCompanies').textContent = totalCompanies;
      document.getElementById('totalSpinsAll').textContent = totalSpinsAll;
      document.getElementById('totalVisitors').textContent = totalVisitors;
      document.getElementById('spinsToday').textContent = spinsToday;
      document.getElementById('spinsWeek').textContent = spinsWeek;
    }

    // 🔹 رسم نمو الدورات
    function drawGrowthChart(spins) {
      const last30Days = {};
      const today = new Date();
      
      for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last30Days[dateStr] = 0;
      }

      spins.forEach(spin => {
        const dateStr = spin.created_at.split('T')[0];
        if (last30Days.hasOwnProperty(dateStr)) {
          last30Days[dateStr]++;
        }
      });

      const ctx = document.getElementById('growthChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: Object.keys(last30Days).map(d => d.substring(5)),
          datasets: [{
            label: 'عدد الدورات',
            data: Object.values(last30Days),
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231,76,60,0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { font: { family: 'Cairo', size: 14 } }
            }
          }
        }
      });
    }

    // 🔹 رسم أفضل الشركات
    function drawTopCompaniesChart(companies, spins) {
      const companyCounts = {};
      
      spins.forEach(spin => {
        companyCounts[spin.company_id] = (companyCounts[spin.company_id] || 0) + 1;
      });

      const sortedCompanies = Object.entries(companyCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const labels = sortedCompanies.map(([id, count]) => {
        const company = companies.find(c => c.id == id);
        return company ? company.name : 'غير معروف';
      });

      const data = sortedCompanies.map(([id, count]) => count);

      const ctx = document.getElementById('topCompaniesChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'عدد الدورات',
            data: data,
            backgroundColor: [
              '#6A3FA0', '#F2C23E', '#FF6B9D', '#4ECDC4', '#8C59C4'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    // 🔹 عرض جدول الشركات
    function renderCompaniesTable(companies, spins) {
      const tbody = document.getElementById('companiesTableBody');
      
      const companiesWithStats = companies.map(company => {
        const companySpins = spins.filter(s => s.company_id === company.id);
        const uniqueVisitors = new Set(companySpins.map(s => s.visitor_name)).size;
        const lastSpin = companySpins[0];

        return {
          ...company,
          spinsCount: companySpins.length,
          visitors: uniqueVisitors,
          lastActivity: lastSpin ? new Date(lastSpin.created_at) : null
        };
      }).sort((a, b) => b.spinsCount - a.spinsCount);

      tbody.innerHTML = companiesWithStats.map(company => {
        const badge = company.spinsCount > 50 ? 'top' : company.spinsCount > 10 ? 'medium' : 'low';
        const badgeText = company.spinsCount > 50 ? '🔥 نشط جداً' : company.spinsCount > 10 ? '⭐ نشط' : '💤 قليل';
        
        const lastActivityText = company.lastActivity 
          ? company.lastActivity.toLocaleDateString('ar-SA')
          : 'لا يوجد';

        return `
          <tr>
            <td><strong>${company.name}</strong></td>
            <td>${company.type || 'غير محدد'}</td>
            <td><strong>${company.spinsCount}</strong></td>
            <td>${company.visitors}</td>
            <td>${lastActivityText}</td>
            <td><span class="badge ${badge}">${badgeText}</span></td>
          </tr>
        `;
      }).join('');
    }

    // 🔹 تصدير CSV
    function exportAdminCSV() {
      const csv = [
        ['ID الشركة', 'اسم الشركة', 'النوع', 'الدورات', 'الزوار', 'التاريخ', 'اسم الزائر', 'الجائزة'],
        ...allSpinsData.map(s => {
          const company = allCompaniesData.find(c => c.id === s.company_id);
          return [
            s.company_id,
            company ? company.name : 'غير معروف',
            company ? company.type : '',
            '',
            '',
            new Date(s.created_at).toLocaleString('ar-SA'),
            s.visitor_name,
            s.prize
          ];
        })
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `dawerha-admin-report-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // 🔹 تصدير تقرير تفصيلي
    function exportDetailedReport() {
      const companySummary = allCompaniesData.map(company => {
        const companySpins = allSpinsData.filter(s => s.company_id === company.id);
        const uniqueVisitors = new Set(companySpins.map(s => s.visitor_name)).size;
        
        return [
          company.name,
          company.type,
          companySpins.length,
          uniqueVisitors,
          company.email,
          company.phone
        ];
      });

      const csv = [
        ['اسم الشركة', 'النوع', 'إجمالي الدورات', 'الزوار المميزون', 'البريد', 'الهاتف'],
        ...companySummary
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `dawerha-companies-summary-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // التحقق من المصادقة ثم تحميل البيانات
    checkAdminAuth().then(session => {
      if (session) {
        loadAdminDashboard();
      }
    });
  </script>
</body>
</html>

