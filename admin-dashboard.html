<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø¯ÙˆÙ‘Ø±Ù‡Ø§</title>
  
  <!-- ğŸ”’ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ù…Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¨Ø­Ø« -->
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  
  <!-- Ù…ÙƒØªØ¨Ø© Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Ù…ÙƒØªØ¨Ø© Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  
  <!-- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ -->
  <script defer src="supabase.js"></script>
  <script defer src="auth.js"></script>
  
  <style>
    :root {
      --admin-primary: #e74c3c;
      --admin-secondary: #3498db;
    }

    .admin-header {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(231,76,60,0.3);
    }

    .admin-header h1 {
      margin: 0;
      font-size: 32px;
    }

    .admin-header p {
      margin: 10px 0 0;
      opacity: 0.9;
    }

    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .mega-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .mega-card {
      background: linear-gradient(135deg, var(--purple) 0%, #8C59C4 100%);
      color: white;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(106,63,160,0.3);
      transition: transform 0.3s ease;
    }

    .mega-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(106,63,160,0.4);
    }

    .mega-card.red {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .mega-card.green {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }

    .mega-card.blue {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    .mega-card.orange {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .mega-card .icon {
      font-size: 50px;
      margin-bottom: 15px;
    }

    .mega-card .value {
      font-size: 48px;
      font-weight: 900;
      margin: 10px 0;
    }

    .mega-card .label {
      font-size: 16px;
      opacity: 0.9;
    }

    .companies-table {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin: 30px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow-x: auto;
    }

    .companies-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .companies-table th {
      background: var(--purple);
      color: white;
      padding: 15px;
      text-align: right;
      font-weight: 700;
    }

    .companies-table td {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .companies-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .badge.top {
      background: #2ecc71;
      color: white;
    }

    .badge.medium {
      background: #f39c12;
      color: white;
    }

    .badge.low {
      background: #95a5a6;
      color: white;
    }

    .chart-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .chart-container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .export-section {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin: 30px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
    }

    .export-btn {
      background: #2ecc71;
      color: white;
      padding: 12px 30px;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      margin: 0 10px;
      transition: all 0.3s ease;
    }

    .export-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .export-btn.excel {
      background: #27ae60;
    }

    .loading {
      text-align: center;
      padding: 60px;
      font-size: 20px;
      color: var(--purple);
    }
  </style>
</head>
<body>
  <!-- Ù‡ÙŠØ¯Ø± Ø¥Ø¯Ø§Ø±ÙŠ -->
  <div class="admin-header">
    <h1>ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
    <p id="adminName">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
    <button onclick="window.authSystem.logout()" style="
      position:absolute;
      top:20px;
      left:20px;
      background:rgba(255,255,255,0.2);
      color:white;
      border:none;
      padding:8px 15px;
      border-radius:8px;
      cursor:pointer;
      font-family:'Cairo',sans-serif;
      font-weight:700;
    ">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="dashboard">
    <div id="loadingAdmin" class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©...</div>

    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¶Ø®Ù…Ø© -->
    <div class="mega-stats" id="megaStats" style="display:none;">
      <div class="mega-card">
        <div class="icon">ğŸ¢</div>
        <div class="value" id="totalCompanies">0</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±ÙƒØ§Øª</div>
      </div>

      <div class="mega-card red">
        <div class="icon">ğŸ¡</div>
        <div class="value" id="totalSpinsAll">0</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</div>
      </div>

      <div class="mega-card green">
        <div class="icon">ğŸ‘¥</div>
        <div class="value" id="totalVisitors">0</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙˆØ§Ø±</div>
      </div>

      <div class="mega-card blue">
        <div class="icon">ğŸ“…</div>
        <div class="value" id="spinsToday">0</div>
        <div class="label">Ø¯ÙˆØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
      </div>

      <div class="mega-card orange">
        <div class="icon">ğŸ“Š</div>
        <div class="value" id="spinsWeek">0</div>
        <div class="label">Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
      </div>
    </div>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="chart-row" id="chartsRow" style="display:none;">
      <div class="chart-container">
        <h3>ğŸ“ˆ Ù†Ù…Ùˆ Ø§Ù„Ø¯ÙˆØ±Ø§Øª - Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</h3>
        <canvas id="growthChart"></canvas>
      </div>

      <div class="chart-container">
        <h3>ğŸ† Ø£ÙØ¶Ù„ 5 Ø´Ø±ÙƒØ§Øª</h3>
        <canvas id="topCompaniesChart"></canvas>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª -->
    <div class="companies-table" id="companiesTable" style="display:none;">
      <h3>ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ£Ø¯Ø§Ø¦Ù‡Ø§</h3>
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø´Ø±ÙƒØ©</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ø¯ÙˆØ±Ø§Øª</th>
            <th>Ø§Ù„Ø²ÙˆØ§Ø±</th>
            <th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</th>
            <th>Ø§Ù„Ø£Ø¯Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="companiesTableBody"></tbody>
      </table>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„ØªØµØ¯ÙŠØ± -->
    <div class="export-section" id="exportSection" style="display:none;">
      <h3>ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
      <p>Ù‚Ù… Ø¨ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„</p>
      <button class="export-btn" onclick="exportAdminCSV()">ğŸ“Š ØªØµØ¯ÙŠØ± CSV</button>
      <button class="export-btn excel" onclick="exportDetailedReport()">ğŸ“‘ ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ</button>
    </div>
  </div>

  <footer class="footer">Â© 2025 Dawerha â€“ Admin Dashboard</footer>

  <script>
    let allCompaniesData = [];
    let allSpinsData = [];

    // ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    async function checkAdminAuth() {
      // ğŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø© Ø¹Ø¨Ø± /admin ÙÙ‚Ø·
      if (!window.location.pathname.includes('/admin')) {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        document.body.innerHTML = `
          <div style="text-align:center; padding:100px; font-family:'Cairo',sans-serif;">
            <h1 style="color:#e74c3c;">ğŸš« ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­</h1>
            <p>Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
            <a href="/" style="color:var(--purple);">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          </div>
        `;
        return null;
      }

      const session = await window.authSystem.requireAuth('admin');
      
      if (!session) {
        return null; // Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      }

      // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
      document.getElementById('adminName').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${session.name} - ${session.role === 'super_admin' ? 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…' : 'Ù…Ø¯ÙŠØ±'}`;

      return session;
    }

    // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
    async function loadAdminDashboard() {
      try {
        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª
        const { data: companies, error: companiesError } = await supabaseClient
          .from("companies")
          .select("*")
          .eq("status", "approved");

        if (companiesError) throw companiesError;

        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
        const { data: spins, error: spinsError } = await supabaseClient
          .from("game_spins")
          .select("*")
          .order("created_at", { ascending: false });

        if (spinsError) throw spinsError;

        allCompaniesData = companies;
        allSpinsData = spins;

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        calculateAdminStats(companies, spins);
        
        // Ø±Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        drawGrowthChart(spins);
        drawTopCompaniesChart(companies, spins);
        
        // Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª
        renderCompaniesTable(companies, spins);

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        document.getElementById('loadingAdmin').style.display = 'none';
        document.getElementById('megaStats').style.display = 'grid';
        document.getElementById('chartsRow').style.display = 'grid';
        document.getElementById('companiesTable').style.display = 'block';
        document.getElementById('exportSection').style.display = 'block';

      } catch (err) {
        console.error("Ø®Ø·Ø£:", err);
        document.getElementById('loadingAdmin').innerHTML = `
          <div style="color:#e74c3c;">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        `;
      }
    }

    // ğŸ”¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
    function calculateAdminStats(companies, spins) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

      const totalCompanies = companies.length;
      const totalSpinsAll = spins.length;
      const totalVisitors = new Set(spins.map(s => s.visitor_name)).size;
      const spinsToday = spins.filter(s => new Date(s.created_at) >= today).length;
      const spinsWeek = spins.filter(s => new Date(s.created_at) >= weekAgo).length;

      document.getElementById('totalCompanies').textContent = totalCompanies;
      document.getElementById('totalSpinsAll').textContent = totalSpinsAll;
      document.getElementById('totalVisitors').textContent = totalVisitors;
      document.getElementById('spinsToday').textContent = spinsToday;
      document.getElementById('spinsWeek').textContent = spinsWeek;
    }

    // ğŸ”¹ Ø±Ø³Ù… Ù†Ù…Ùˆ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
    function drawGrowthChart(spins) {
      const last30Days = {};
      const today = new Date();
      
      for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last30Days[dateStr] = 0;
      }

      spins.forEach(spin => {
        const dateStr = spin.created_at.split('T')[0];
        if (last30Days.hasOwnProperty(dateStr)) {
          last30Days[dateStr]++;
        }
      });

      const ctx = document.getElementById('growthChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: Object.keys(last30Days).map(d => d.substring(5)),
          datasets: [{
            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª',
            data: Object.values(last30Days),
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231,76,60,0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { font: { family: 'Cairo', size: 14 } }
            }
          }
        }
      });
    }

    // ğŸ”¹ Ø±Ø³Ù… Ø£ÙØ¶Ù„ Ø§Ù„Ø´Ø±ÙƒØ§Øª
    function drawTopCompaniesChart(companies, spins) {
      const companyCounts = {};
      
      spins.forEach(spin => {
        companyCounts[spin.company_id] = (companyCounts[spin.company_id] || 0) + 1;
      });

      const sortedCompanies = Object.entries(companyCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const labels = sortedCompanies.map(([id, count]) => {
        const company = companies.find(c => c.id == id);
        return company ? company.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      });

      const data = sortedCompanies.map(([id, count]) => count);

      const ctx = document.getElementById('topCompaniesChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª',
            data: data,
            backgroundColor: [
              '#6A3FA0', '#F2C23E', '#FF6B9D', '#4ECDC4', '#8C59C4'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    // ğŸ”¹ Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª
    function renderCompaniesTable(companies, spins) {
      const tbody = document.getElementById('companiesTableBody');
      
      const companiesWithStats = companies.map(company => {
        const companySpins = spins.filter(s => s.company_id === company.id);
        const uniqueVisitors = new Set(companySpins.map(s => s.visitor_name)).size;
        const lastSpin = companySpins[0];

        return {
          ...company,
          spinsCount: companySpins.length,
          visitors: uniqueVisitors,
          lastActivity: lastSpin ? new Date(lastSpin.created_at) : null
        };
      }).sort((a, b) => b.spinsCount - a.spinsCount);

      tbody.innerHTML = companiesWithStats.map(company => {
        const badge = company.spinsCount > 50 ? 'top' : company.spinsCount > 10 ? 'medium' : 'low';
        const badgeText = company.spinsCount > 50 ? 'ğŸ”¥ Ù†Ø´Ø· Ø¬Ø¯Ø§Ù‹' : company.spinsCount > 10 ? 'â­ Ù†Ø´Ø·' : 'ğŸ’¤ Ù‚Ù„ÙŠÙ„';
        
        const lastActivityText = company.lastActivity 
          ? company.lastActivity.toLocaleDateString('ar-SA')
          : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

        return `
          <tr>
            <td><strong>${company.name}</strong></td>
            <td>${company.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
            <td><strong>${company.spinsCount}</strong></td>
            <td>${company.visitors}</td>
            <td>${lastActivityText}</td>
            <td><span class="badge ${badge}">${badgeText}</span></td>
          </tr>
        `;
      }).join('');
    }

    // ğŸ”¹ ØªØµØ¯ÙŠØ± CSV
    function exportAdminCSV() {
      const csv = [
        ['ID Ø§Ù„Ø´Ø±ÙƒØ©', 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©', 'Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø¯ÙˆØ±Ø§Øª', 'Ø§Ù„Ø²ÙˆØ§Ø±', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±', 'Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©'],
        ...allSpinsData.map(s => {
          const company = allCompaniesData.find(c => c.id === s.company_id);
          return [
            s.company_id,
            company ? company.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
            company ? company.type : '',
            '',
            '',
            new Date(s.created_at).toLocaleString('ar-SA'),
            s.visitor_name,
            s.prize
          ];
        })
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `dawerha-admin-report-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // ğŸ”¹ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ
    function exportDetailedReport() {
      const companySummary = allCompaniesData.map(company => {
        const companySpins = allSpinsData.filter(s => s.company_id === company.id);
        const uniqueVisitors = new Set(companySpins.map(s => s.visitor_name)).size;
        
        return [
          company.name,
          company.type,
          companySpins.length,
          uniqueVisitors,
          company.email,
          company.phone
        ];
      });

      const csv = [
        ['Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©', 'Ø§Ù„Ù†ÙˆØ¹', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª', 'Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…Ù…ÙŠØ²ÙˆÙ†', 'Ø§Ù„Ø¨Ø±ÙŠØ¯', 'Ø§Ù„Ù‡Ø§ØªÙ'],
        ...companySummary
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `dawerha-companies-summary-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø«Ù… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    checkAdminAuth().then(session => {
      if (session) {
        loadAdminDashboard();
      }
    });
  </script>
</body>
</html>

