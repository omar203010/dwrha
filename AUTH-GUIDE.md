# 🔐 دليل نظام المصادقة - دوّرها

## نظرة عامة

تم تطوير نظام مصادقة متكامل لـ "دوّرها" حيث كل شركة لها حساب مستقل ومحمي، ولوحة تحكم الإدارة محمية بمصادقة منفصلة.

---

## 🚀 خطوات الإعداد السريع

### 1️⃣ تحديث قاعدة البيانات

قم بتنفيذ السكريبت التالي في Supabase SQL Editor:

```sql
-- نفّذ محتوى ملف: supabase-auth-update.sql
```

هذا السكريبت سيضيف:
- ✅ حقول المصادقة لجدول `companies`
- ✅ جدول `admin_users` للمستخدمين الإداريين
- ✅ جدول `sessions` لإدارة الجلسات
- ✅ حساب إداري افتراضي

### 2️⃣ الحساب الإداري الافتراضي

**البريد الإلكتروني:** `admin@dawerha.com`  
**كلمة المرور:** `Dawerha@2025`

⚠️ **مهم جداً:** غيّر كلمة المرور فوراً بعد أول تسجيل دخول!

---

## 📋 سير العمل الكامل

### للشركات:

#### 1. التسجيل
```
الشركة → index.html → تسجيل البيانات
         ↓
    يتم إنشاء حساب تلقائياً
         ↓
    كلمة مرور عشوائية قوية
         ↓
    صفحة الشكر + بيانات الدخول
```

**ما يحدث في الخلفية:**
- توليد كلمة مرور آمنة تلقائياً (مثال: `DwrhaA7xK3m@2025`)
- تشفير كلمة المرور قبل الحفظ
- الحساب يكون غير نشط (`is_active = false`)
- الحالة: `pending` (قيد المراجعة)

#### 2. الموافقة من الإدارة
```
الإدارة → admin-dashboard.html
         ↓
    مراجعة الطلبات
         ↓
    تغيير status → "approved"
    تغيير is_active → true
```

⚠️ **ملاحظة:** يجب على الإدارة تفعيل الحسابات يدوياً حالياً.  
💡 **تحسين مستقبلي:** إضافة واجهة لتفعيل/رفض الطلبات من لوحة الإدارة.

#### 3. تسجيل الدخول
```
الشركة → login.html
         ↓
    إدخال Email + Password
         ↓
    التحقق من البيانات
         ↓
    إنشاء جلسة (Session)
         ↓
    company-dashboard.html
```

#### 4. الوصول للوحة التحكم
- **من company.html:** إذا كانت الشركة مسجلة دخول، يظهر زر "لوحة التحكم"
- **من thanks.html:** رابط مباشر بعد التسجيل
- **من login.html:** بعد تسجيل الدخول الناجح

---

## 🔐 الأمان والحماية

### مستويات الحماية:

1. **تشفير كلمات المرور:**
   - استخدام Base64 + Salt مخصص
   - 💡 للإنتاج: استبدل بـ bcrypt أو argon2

2. **نظام الجلسات:**
   - Token فريد لكل جلسة
   - صلاحية محددة (24 ساعة للشركات، 12 ساعة للإدارة)
   - Session ID مخزن في `localStorage`
   - التحقق المزدوج (localStorage + قاعدة البيانات)

3. **التحقق من الصلاحيات:**
   - كل شركة ترى بياناتها فقط
   - محاولة الوصول لبيانات شركة أخرى = رفض + إعادة توجيه
   - لوحة الإدارة: تحقق من نوع المستخدم (`admin`)

4. **Row Level Security:**
   - مُفعّل على جميع الجداول الحساسة
   - سياسات قراءة وكتابة مناسبة

---

## 🎯 الملفات الجديدة

| الملف | الوصف |
|------|-------|
| `supabase-auth-update.sql` | سكريبت تحديث قاعدة البيانات |
| `auth.js` | نظام المصادقة الكامل |
| `login.html` | صفحة تسجيل دخول الشركات |
| `admin-login.html` | صفحة تسجيل دخول الإدارة |

## 📝 الملفات المُعدّلة

| الملف | التعديلات |
|------|----------|
| `main.js` | إنشاء حساب تلقائياً عند التسجيل |
| `thanks.html` | عرض بيانات تسجيل الدخول |
| `company.html` | زر لوحة التحكم + تسجيل الخروج |
| `company-dashboard.html` | حماية بالمصادقة |
| `admin-dashboard.html` | حماية بالمصادقة |

---

## 🛠️ دوال نظام المصادقة (auth.js)

### للشركات:
```javascript
// تسجيل الدخول
await window.authSystem.loginCompany(email, password);

// الحصول على الجلسة الحالية
const session = window.authSystem.getCurrentSession();

// التحقق من تسجيل الدخول (للصفحات المحمية)
await window.authSystem.requireAuth('company');

// تسجيل الخروج
window.authSystem.logout();
```

### للإدارة:
```javascript
// تسجيل دخول إداري
await window.authSystem.loginAdmin(email, password);

// التحقق من صلاحيات إدارية
await window.authSystem.requireAuth('admin');
```

### عامة:
```javascript
// توليد كلمة مرور قوية
generatePassword(); // → "DwrhaX7mK2@2025"

// تشفير كلمة المرور
hashPassword("mypassword"); // → encrypted string
```

---

## 📊 هيكل الجلسة (Session)

```javascript
{
  token: "dwrha_abc123...",
  userType: "company" | "admin",
  userId: 123,
  email: "company@example.com",
  name: "اسم الشركة",
  expiresAt: "2025-10-08T12:00:00Z"
}
```

---

## 🔄 سيناريوهات الاستخدام

### السيناريو 1: شركة جديدة تسجل

```
1. الشركة تفتح index.html
2. تملأ النموذج وترسل
3. ✅ يتم إنشاء:
   - سجل في جدول companies
   - كلمة مرور عشوائية مشفرة
   - الحالة: pending, is_active: false
4. تُحوّل لصفحة thanks.html
5. تعرض لها:
   - رابط العجلة
   - بيانات تسجيل الدخول
   - رابط login.html
6. ⏳ تنتظر موافقة الإدارة
```

### السيناريو 2: الإدارة تفعّل الحساب

```
1. الإدارة تدخل admin-dashboard.html
2. ترى جدول الشركات
3. تفتح قاعدة البيانات (Supabase)
4. UPDATE companies 
   SET status = 'approved', is_active = true 
   WHERE id = X
5. ✅ الشركة الآن يمكنها تسجيل الدخول
```

💡 **تحسين مستقبلي:** إضافة أزرار تفعيل/رفض في لوحة الإدارة.

### السيناريو 3: الشركة تسجل دخول

```
1. الشركة تفتح login.html
2. تدخل Email + Password
3. ✅ التحقق:
   - البريد موجود؟
   - كلمة المرور صحيحة؟
   - is_active = true؟
   - status = approved؟
4. إنشاء Session جديدة
5. تحويل → company-dashboard.html
6. ✅ ترى إحصائياتها
```

### السيناريو 4: عميل يدخل صفحة العجلة

```
1. عميل يفتح company.html?id=123
2. ✅ يرى:
   - اسم الشركة
   - العجلة
   - زر "تسجيل دخول المالك" (صغير)
3. إذا كان المالك مسجل دخول:
   ✅ يرى: "لوحة التحكم" + "تسجيل الخروج"
4. يلعب ويفوز بالجائزة
5. ✅ البيانات تُحفظ تلقائياً
```

---

## ⚡ التحسينات المقترحة

### قريباً:
1. **واجهة تفعيل الحسابات:**
   - أزرار Approve/Reject في admin-dashboard
   - إشعارات للشركات عبر البريد

2. **تغيير كلمة المرور:**
   - صفحة لتغيير كلمة المرور
   - "نسيت كلمة المرور" مع إرسال رابط

3. **أدوار متعددة للإدارة:**
   - super_admin: كل الصلاحيات
   - admin: صلاحيات محدودة
   - viewer: قراءة فقط

### لاحقاً:
4. **Two-Factor Authentication (2FA)**
5. **تسجيل الدخول بـ OAuth** (Google, Facebook)
6. **تشفير أقوى** (bcrypt, argon2)
7. **Refresh Tokens** لجلسات أطول
8. **IP Whitelisting** للإدارة
9. **Audit Logs** - سجل كل العمليات

---

## 🆘 استكشاف الأخطاء

### المشكلة: "البريد أو كلمة المرور غير صحيحة"
**الحل:**
- تأكد من كتابة البريد بشكل صحيح
- كلمة المرور حساسة لحالة الأحرف
- تأكد من نسخ كلمة المرور من صفحة الشكر

### المشكلة: "حسابك غير مفعّل"
**الحل:**
- انتظر موافقة الإدارة
- تواصل مع فريق دوّرها
- تحقق من الحالة في قاعدة البيانات

### المشكلة: "ليس لديك صلاحية"
**الحل:**
- تأكد من استخدام الحساب الصحيح
- لا يمكنك رؤية بيانات شركات أخرى
- سجّل دخول بحسابك الخاص

### المشكلة: الجلسة انتهت
**الحل:**
- سجّل دخول مرة أخرى
- الجلسات صالحة لـ 24 ساعة فقط
- إذا استمرت المشكلة، امسح الكاش

---

## 📞 بيانات الاتصال للدعم

للمساعدة في نظام المصادقة:
- راجع هذا الدليل
- تحقق من Console المتصفح
- تواصل مع فريق التطوير

---

## 🎉 الخلاصة

✅ **نظام مصادقة كامل ومحمي**  
✅ **كل شركة لها حسابها المستقل**  
✅ **لوحة إدارية محمية بشكل منفصل**  
✅ **جلسات آمنة مع انتهاء صلاحية**  
✅ **حماية متعددة المستويات**  
✅ **سهل الاستخدام والتطوير**  

**"دوّرها" الآن منصة آمنة واحترافية!** 🚀🔐

