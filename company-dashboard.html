<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم | دوّرها</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  
  <!-- مكتبة Chart.js للرسوم البيانية -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- مكتبة Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  
  <!-- إعداد الاتصال -->
  <script defer src="supabase.js"></script>
  <script defer src="auth.js"></script>
  
  <style>
    .dashboard {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .stat-card {
      background: #fff;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 2px solid rgba(106,63,160,0.1);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(106,63,160,0.15);
    }
    
    .stat-card .icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 36px;
      font-weight: 900;
      color: var(--purple);
      margin: 10px 0;
    }
    
    .stat-card .label {
      color: #666;
      font-size: 14px;
    }
    
    .chart-container {
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .header-dash {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .export-btn {
      background: #2ecc71;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }
    
    .export-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }
    
    .recent-spins {
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .spin-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .spin-item:last-child {
      border-bottom: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--purple);
      font-size: 18px;
    }
  </style>
</head>
<body>
  <!-- سدو علوي -->
  <img src="assets/sadu-strip.jpeg" alt="سدو علوي" class="sadu-img">

  <!-- هيدر -->
  <header class="hero">
    <img src="assets/logo-dawerha.jpeg" alt="شعار دوّرها" class="hero-logo">
    <h1 class="hero-title">📊 لوحة التحكم</h1>
    <p id="companyNameHeader"></p>
  </header>

  <!-- لوحة التحكم -->
  <div class="dashboard">
    <div class="header-dash">
      <h2>📈 الإحصائيات</h2>
      <div>
        <button class="export-btn" onclick="exportToCSV()">📥 تصدير CSV</button>
        <a href="company.html" id="backToWheel" class="btn primary" style="margin-right:10px">🎡 العودة للعجلة</a>
        <button onclick="window.authSystem.logout()" class="btn" style="background:#e74c3c; color:white; margin-right:10px">🚪 تسجيل الخروج</button>
      </div>
    </div>

    <div id="loadingStats" class="loading">⏳ جاري تحميل البيانات...</div>

    <!-- بطاقات الإحصائيات -->
    <div class="stats-grid" id="statsGrid" style="display:none;">
      <div class="stat-card">
        <div class="icon">👥</div>
        <div class="value" id="totalSpins">0</div>
        <div class="label">إجمالي الدورات</div>
      </div>

      <div class="stat-card">
        <div class="icon">🎯</div>
        <div class="value" id="uniqueVisitors">0</div>
        <div class="label">زوار مميزون</div>
      </div>

      <div class="stat-card">
        <div class="icon">📅</div>
        <div class="value" id="spinsToday">0</div>
        <div class="label">دورات اليوم</div>
      </div>

      <div class="stat-card">
        <div class="icon">📊</div>
        <div class="value" id="spinsWeek">0</div>
        <div class="label">دورات الأسبوع</div>
      </div>
    </div>

    <!-- الرسوم البيانية -->
    <div id="chartsContainer" style="display:none;">
      <div class="chart-container">
        <h3>🎁 توزيع الجوائز</h3>
        <canvas id="prizeChart"></canvas>
      </div>

      <div class="chart-container">
        <h3>📈 الدورات خلال آخر 7 أيام</h3>
        <canvas id="timelineChart"></canvas>
      </div>
    </div>

    <!-- آخر الدورات -->
    <div class="recent-spins" id="recentSpinsContainer" style="display:none;">
      <h3>🕒 آخر الدورات</h3>
      <div id="recentSpinsList"></div>
    </div>
  </div>

  <footer class="footer">© 2025 Dawerha – جميع الحقوق محفوظة</footer>

  <script>
    // 🔹 الحصول على ID الشركة من الرابط
    function getCompanyId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    const companyId = getCompanyId();

    // 🔐 التحقق من تسجيل الدخول
    async function checkAuth() {
      const session = await window.authSystem.requireAuth('company');
      
      if (!session) {
        return; // سيتم إعادة التوجيه تلقائياً
      }

      // التحقق من أن المستخدم يصل لبياناته فقط
      if (session.userId != companyId) {
        alert('ليس لديك صلاحية لعرض بيانات هذه الشركة');
        window.location.href = `company-dashboard.html?id=${session.userId}`;
        return;
      }

      // عرض اسم المستخدم في الهيدر
      document.getElementById('companyNameHeader').textContent = session.name;

      return session;
    }

    if (!companyId) {
      document.body.innerHTML = `
        <h2 style="text-align:center; color:#e74c3c; margin-top:60px;">
          ❌ لم يتم العثور على الشركة
        </h2>
      `;
    } else {
      // التحقق من المصادقة ثم تحميل البيانات
      checkAuth().then(session => {
        if (session) {
          // تحديث رابط العودة للعجلة
          document.getElementById('backToWheel').href = `company.html?id=${companyId}`;
          
          loadDashboard();
        }
      });
    }

    // 🔹 تحميل بيانات لوحة التحكم
    async function loadDashboard() {
      try {
        // جلب معلومات الشركة
        const { data: company, error: companyError } = await supabaseClient
          .from("companies")
          .select("*")
          .eq("id", companyId)
          .single();

        if (companyError || !company) {
          throw new Error("لم يتم العثور على الشركة");
        }

        document.getElementById('companyNameHeader').textContent = company.name;

        // جلب الإحصائيات
        const { data: spins, error: spinsError } = await supabaseClient
          .from("game_spins")
          .select("*")
          .eq("company_id", companyId)
          .order("created_at", { ascending: false });

        if (spinsError) {
          throw new Error(spinsError.message);
        }

        // حساب الإحصائيات
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

        const totalSpins = spins.length;
        const uniqueVisitors = new Set(spins.map(s => s.visitor_name)).size;
        const spinsToday = spins.filter(s => new Date(s.created_at) >= today).length;
        const spinsWeek = spins.filter(s => new Date(s.created_at) >= weekAgo).length;

        // عرض الإحصائيات
        document.getElementById('totalSpins').textContent = totalSpins;
        document.getElementById('uniqueVisitors').textContent = uniqueVisitors;
        document.getElementById('spinsToday').textContent = spinsToday;
        document.getElementById('spinsWeek').textContent = spinsWeek;

        document.getElementById('loadingStats').style.display = 'none';
        document.getElementById('statsGrid').style.display = 'grid';
        document.getElementById('chartsContainer').style.display = 'block';
        document.getElementById('recentSpinsContainer').style.display = 'block';

        // رسم الرسوم البيانية
        drawPrizeChart(spins);
        drawTimelineChart(spins);
        
        // عرض آخر الدورات
        showRecentSpins(spins.slice(0, 10));

      } catch (err) {
        console.error("خطأ:", err);
        document.getElementById('loadingStats').innerHTML = `
          <div style="color:#e74c3c;">❌ حدث خطأ في تحميل البيانات</div>
        `;
      }
    }

    // 🔹 رسم توزيع الجوائز
    function drawPrizeChart(spins) {
      const prizeCount = {};
      spins.forEach(spin => {
        prizeCount[spin.prize] = (prizeCount[spin.prize] || 0) + 1;
      });

      const ctx = document.getElementById('prizeChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(prizeCount),
          datasets: [{
            data: Object.values(prizeCount),
            backgroundColor: [
              '#6A3FA0', '#F2C23E', '#FF6B9D', '#4ECDC4', 
              '#8C59C4', '#FF8B5A', '#B794F6', '#2E2240'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { family: 'Cairo', size: 14 }
              }
            }
          }
        }
      });
    }

    // 🔹 رسم الدورات خلال آخر 7 أيام
    function drawTimelineChart(spins) {
      const last7Days = {};
      const today = new Date();
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last7Days[dateStr] = 0;
      }

      spins.forEach(spin => {
        const dateStr = spin.created_at.split('T')[0];
        if (last7Days.hasOwnProperty(dateStr)) {
          last7Days[dateStr]++;
        }
      });

      const ctx = document.getElementById('timelineChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: Object.keys(last7Days),
          datasets: [{
            label: 'عدد الدورات',
            data: Object.values(last7Days),
            borderColor: '#6A3FA0',
            backgroundColor: 'rgba(106,63,160,0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                font: { family: 'Cairo', size: 14 }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // 🔹 عرض آخر الدورات
    function showRecentSpins(spins) {
      const container = document.getElementById('recentSpinsList');
      
      if (spins.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#999">لا توجد دورات بعد</p>';
        return;
      }

      container.innerHTML = spins.map(spin => {
        const date = new Date(spin.created_at);
        const timeStr = date.toLocaleString('ar-SA', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        return `
          <div class="spin-item">
            <div>
              <strong>${spin.visitor_name}</strong> - 🎁 ${spin.prize}
            </div>
            <div style="color:#999;font-size:12px">${timeStr}</div>
          </div>
        `;
      }).join('');
    }

    // 🔹 تصدير البيانات إلى CSV
    async function exportToCSV() {
      try {
        const { data: spins, error } = await supabaseClient
          .from("game_spins")
          .select("*")
          .eq("company_id", companyId)
          .order("created_at", { ascending: false });

        if (error) throw error;

        const csv = [
          ['التاريخ', 'الاسم', 'الجائزة', 'Session ID'],
          ...spins.map(s => [
            new Date(s.created_at).toLocaleString('ar-SA'),
            s.visitor_name,
            s.prize,
            s.session_id
          ])
        ].map(row => row.join(',')).join('\n');

        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `dawerha-report-${companyId}-${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
      } catch (err) {
        alert('حدث خطأ في التصدير: ' + err.message);
      }
    }
  </script>
</body>
</html>

