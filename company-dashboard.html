<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø¯ÙˆÙ‘Ø±Ù‡Ø§</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  
  <!-- Ù…ÙƒØªØ¨Ø© Chart.js Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Ù…ÙƒØªØ¨Ø© Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  
  <!-- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ -->
  <script defer src="supabase.js"></script>
  <script defer src="auth.js"></script>
  
  <style>
    .dashboard {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .stat-card {
      background: #fff;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 2px solid rgba(106,63,160,0.1);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(106,63,160,0.15);
    }
    
    .stat-card .icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 36px;
      font-weight: 900;
      color: var(--purple);
      margin: 10px 0;
    }
    
    .stat-card .label {
      color: #666;
      font-size: 14px;
    }
    
    .chart-container {
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .header-dash {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .export-btn {
      background: #2ecc71;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }
    
    .export-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }
    
    .recent-spins {
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .spin-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .spin-item:last-child {
      border-bottom: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--purple);
      font-size: 18px;
    }
  </style>
</head>
<body>
  <!-- Ø³Ø¯Ùˆ Ø¹Ù„ÙˆÙŠ -->
  <img src="assets/sadu-strip.jpeg" alt="Ø³Ø¯Ùˆ Ø¹Ù„ÙˆÙŠ" class="sadu-img">

  <!-- Ù‡ÙŠØ¯Ø± -->
  <header class="hero">
    <img src="assets/logo-dawerha.jpeg" alt="Ø´Ø¹Ø§Ø± Ø¯ÙˆÙ‘Ø±Ù‡Ø§" class="hero-logo">
    <h1 class="hero-title">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
    <p id="companyNameHeader"></p>
  </header>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
  <div class="dashboard">
    <div class="header-dash">
      <h2>ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
      <div>
        <button class="export-btn" onclick="exportToCSV()">ğŸ“¥ ØªØµØ¯ÙŠØ± CSV</button>
        <a href="company.html" id="backToWheel" class="btn primary" style="margin-right:10px">ğŸ¡ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø¬Ù„Ø©</a>
        <button onclick="window.authSystem.logout()" class="btn" style="background:#e74c3c; color:white; margin-right:10px">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div id="loadingStats" class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="stats-grid" id="statsGrid" style="display:none;">
      <div class="stat-card">
        <div class="icon">ğŸ‘¥</div>
        <div class="value" id="totalSpins">0</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</div>
      </div>

      <div class="stat-card">
        <div class="icon">ğŸ¯</div>
        <div class="value" id="uniqueVisitors">0</div>
        <div class="label">Ø²ÙˆØ§Ø± Ù…Ù…ÙŠØ²ÙˆÙ†</div>
      </div>

      <div class="stat-card">
        <div class="icon">ğŸ“…</div>
        <div class="value" id="spinsToday">0</div>
        <div class="label">Ø¯ÙˆØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
      </div>

      <div class="stat-card">
        <div class="icon">ğŸ“Š</div>
        <div class="value" id="spinsWeek">0</div>
        <div class="label">Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
      </div>
    </div>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div id="chartsContainer" style="display:none;">
      <div class="chart-container">
        <h3>ğŸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</h3>
        <canvas id="prizeChart"></canvas>
      </div>

      <div class="chart-container">
        <h3>ğŸ“ˆ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</h3>
        <canvas id="timelineChart"></canvas>
      </div>
    </div>

    <!-- Ø¢Ø®Ø± Ø§Ù„Ø¯ÙˆØ±Ø§Øª -->
    <div class="recent-spins" id="recentSpinsContainer" style="display:none;">
      <h3>ğŸ•’ Ø¢Ø®Ø± Ø§Ù„Ø¯ÙˆØ±Ø§Øª</h3>
      <div id="recentSpinsList"></div>
    </div>
  </div>

  <footer class="footer">Â© 2025 Dawerha â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</footer>

  <script>
    // ğŸ”¹ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    function getCompanyId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    const companyId = getCompanyId();

    // ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function checkAuth() {
      const session = await window.authSystem.requireAuth('company');
      
      if (!session) {
        return; // Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØµÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙÙ‚Ø·
      if (session.userId != companyId) {
        alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ©');
        window.location.href = `company-dashboard.html?id=${session.userId}`;
        return;
      }

      // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
      document.getElementById('companyNameHeader').textContent = session.name;

      return session;
    }

    if (!companyId) {
      document.body.innerHTML = `
        <h2 style="text-align:center; color:#e74c3c; margin-top:60px;">
          âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©
        </h2>
      `;
    } else {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø«Ù… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      checkAuth().then(session => {
        if (session) {
          // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø¬Ù„Ø©
          document.getElementById('backToWheel').href = `company.html?id=${companyId}`;
          
          loadDashboard();
        }
      });
    }

    // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    async function loadDashboard() {
      try {
        // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
        const { data: company, error: companyError } = await supabaseClient
          .from("companies")
          .select("*")
          .eq("id", companyId)
          .single();

        if (companyError || !company) {
          throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©");
        }

        document.getElementById('companyNameHeader').textContent = company.name;

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const { data: spins, error: spinsError } = await supabaseClient
          .from("game_spins")
          .select("*")
          .eq("company_id", companyId)
          .order("created_at", { ascending: false });

        if (spinsError) {
          throw new Error(spinsError.message);
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

        const totalSpins = spins.length;
        const uniqueVisitors = new Set(spins.map(s => s.visitor_name)).size;
        const spinsToday = spins.filter(s => new Date(s.created_at) >= today).length;
        const spinsWeek = spins.filter(s => new Date(s.created_at) >= weekAgo).length;

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        document.getElementById('totalSpins').textContent = totalSpins;
        document.getElementById('uniqueVisitors').textContent = uniqueVisitors;
        document.getElementById('spinsToday').textContent = spinsToday;
        document.getElementById('spinsWeek').textContent = spinsWeek;

        document.getElementById('loadingStats').style.display = 'none';
        document.getElementById('statsGrid').style.display = 'grid';
        document.getElementById('chartsContainer').style.display = 'block';
        document.getElementById('recentSpinsContainer').style.display = 'block';

        // Ø±Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        drawPrizeChart(spins);
        drawTimelineChart(spins);
        
        // Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ø¯ÙˆØ±Ø§Øª
        showRecentSpins(spins.slice(0, 10));

      } catch (err) {
        console.error("Ø®Ø·Ø£:", err);
        document.getElementById('loadingStats').innerHTML = `
          <div style="color:#e74c3c;">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        `;
      }
    }

    // ğŸ”¹ Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²
    function drawPrizeChart(spins) {
      const prizeCount = {};
      spins.forEach(spin => {
        prizeCount[spin.prize] = (prizeCount[spin.prize] || 0) + 1;
      });

      const ctx = document.getElementById('prizeChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(prizeCount),
          datasets: [{
            data: Object.values(prizeCount),
            backgroundColor: [
              '#6A3FA0', '#F2C23E', '#FF6B9D', '#4ECDC4', 
              '#8C59C4', '#FF8B5A', '#B794F6', '#2E2240'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { family: 'Cairo', size: 14 }
              }
            }
          }
        }
      });
    }

    // ğŸ”¹ Ø±Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
    function drawTimelineChart(spins) {
      const last7Days = {};
      const today = new Date();
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last7Days[dateStr] = 0;
      }

      spins.forEach(spin => {
        const dateStr = spin.created_at.split('T')[0];
        if (last7Days.hasOwnProperty(dateStr)) {
          last7Days[dateStr]++;
        }
      });

      const ctx = document.getElementById('timelineChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: Object.keys(last7Days),
          datasets: [{
            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª',
            data: Object.values(last7Days),
            borderColor: '#6A3FA0',
            backgroundColor: 'rgba(106,63,160,0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                font: { family: 'Cairo', size: 14 }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // ğŸ”¹ Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ø¯ÙˆØ±Ø§Øª
    function showRecentSpins(spins) {
      const container = document.getElementById('recentSpinsList');
      
      if (spins.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª Ø¨Ø¹Ø¯</p>';
        return;
      }

      container.innerHTML = spins.map(spin => {
        const date = new Date(spin.created_at);
        const timeStr = date.toLocaleString('ar-SA', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        return `
          <div class="spin-item">
            <div>
              <strong>${spin.visitor_name}</strong> - ğŸ ${spin.prize}
            </div>
            <div style="color:#999;font-size:12px">${timeStr}</div>
          </div>
        `;
      }).join('');
    }

    // ğŸ”¹ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ CSV
    async function exportToCSV() {
      try {
        const { data: spins, error } = await supabaseClient
          .from("game_spins")
          .select("*")
          .eq("company_id", companyId)
          .order("created_at", { ascending: false });

        if (error) throw error;

        const csv = [
          ['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©', 'Session ID'],
          ...spins.map(s => [
            new Date(s.created_at).toLocaleString('ar-SA'),
            s.visitor_name,
            s.prize,
            s.session_id
          ])
        ].map(row => row.join(',')).join('\n');

        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `dawerha-report-${companyId}-${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
      } catch (err) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + err.message);
      }
    }
  </script>
</body>
</html>

